{% extends "scheduler/base.html" %}
{% load filters %}

{% block content %}
<div class="container mt-4">
    {% include 'leads/_leads_nav.html' %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 mb-4">
        <div class="col">
            <div class="card text-center h-100 text-primary">
                <div class="card-body py-3 py-md-4">
                    <h6 class="card-title text-muted mb-1">Total de Leads</h6>
                    <p class="card-text fs-3 fs-md-4 fw-bold">{{ total_leads }}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center h-100 text-success">
                <div class="card-body py-3 py-md-4">
                    <h6 class="card-title text-muted mb-1">Leads Convertidos</h6>
                    <p class="card-text fs-3 fs-md-4 fw-bold">{{ leads_convertidos }}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center h-100 text-info">
                <div class="card-body py-3 py-md-4">
                    <h6 class="card-title text-muted mb-1">Taxa de Conversão</h6>
                    <p class="card-text fs-3 fs-md-4 fw-bold">{{ taxa_conversao }}%</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Origem dos Leads</h5>
                    <div class="chart-container">
                        <canvas id="graficoFontes"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">Leads por Status</h5>
                    <div class="chart-container">
                        <canvas id="graficoStatus"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Últimos Leads</h5>
                    
                    <div class="table-responsive d-none d-md-block">
                        <table class="table table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th scope="col">Nome</th>
                                    <th scope="col" class="text-center">Status</th>
                                    <th scope="col" class="text-end">Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lead in ultimos_leads %}
                                <tr>
                                    <td>
                                        <a href="{% url 'leads:lead_detalhe' lead.pk %}" class="fw-semibold text-decoration-none">
                                            {{ lead.nome_interessado.title }}
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge rounded-pill
                                            {% if lead.status == 'convertido' %} bg-success-subtle text-success-emphasis
                                            {% elif lead.status == 'perdido' %} bg-danger-subtle text-danger-emphasis
                                            {% elif lead.status == 'em_contato' %} bg-warning-subtle text-warning-emphasis
                                            {% elif lead.status == 'negociando' %} bg-info-subtle text-info-emphasis
                                            {% else %} bg-secondary-subtle text-secondary-emphasis {% endif %}">
                                            {{ lead.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="text-end text-muted small">
                                        {{ lead.data_criacao|date:"d/m/Y" }}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">Nenhum lead recente.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="d-md-none">
                        <ul class="list-group list-group-flush">
                            {% for lead in ultimos_leads %}
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <a href="{% url 'leads:lead_detalhe' lead.pk %}" class="fw-semibold text-decoration-none d-block">
                                        {{ lead.nome_interessado.title|smart_truncate:2 }}
                                    </a>
                                    <small class="text-muted">{{ lead.data_criacao|date:"d/m/Y" }}</small>
                                </div>
                                <span class="badge rounded-pill flex-shrink-0 ms-2
                                    {% if lead.status == 'convertido' %} bg-success-subtle text-success-emphasis
                                    {% elif lead.status == 'perdido' %} bg-danger-subtle text-danger-emphasis
                                    {% elif lead.status == 'em_contato' %} bg-warning-subtle text-warning-emphasis
                                    {% elif lead.status == 'negociando' %} bg-info-subtle text-info-emphasis
                                    {% else %} bg-secondary-subtle text-secondary-emphasis {% endif %}">
                                    {{ lead.get_status_display }}
                                </span>
                            </li>
                            {% empty %}
                            <li class="list-group-item px-0 text-center text-muted py-4">Nenhum lead recente.</li>
                            {% endfor %}
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --chart-text-color: #6c757d;
    --chart-grid-color: rgba(0, 0, 0, 0.1);
    --chart-pie-border-color: #fff;
}

[data-bs-theme="dark"] {
    --chart-text-color: #adb5bd;
    --chart-grid-color: rgba(255, 255, 255, 0.1);
    --chart-pie-border-color: #212529;
}

.chart-container {
    position: relative;
    width: 100%;
    min-height: 250px;
}

@media (min-width: 768px) {
    .chart-container {
        min-height: 300px;
    }
}
</style>
{% include 'leads/partials/_filter_panel.html' %}
{% endblock %}
{% block extra_js %}
{{ block.super }}
{% include 'leads/partials/_filter_panel_js.html' %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();

    // --- Gráfico de Fontes (Bar) ---
    // Nenhuma alteração aqui
    const ctxFontes = document.getElementById('graficoFontes').getContext('2d');
    const fontesLabels = JSON.parse('{{ fontes_labels|safe }}');
    const fontesData = JSON.parse('{{ fontes_data|safe }}');
    const barChart = new Chart(ctxFontes, {
        type: 'bar',
        data: {
            labels: fontesLabels,
            datasets: [{
                label: 'Nº de Leads por Fonte',
                data: fontesData,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: getCssVar('--chart-text-color') // Cor dinâmica
                    },
                    grid: {
                        color: getCssVar('--chart-grid-color') // Cor dinâmica
                    }
                },
                x: {
                    ticks: {
                        color: getCssVar('--chart-text-color') // Cor dinâmica
                    },
                    grid: {
                        color: 'transparent'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });


    // --- Gráfico de Status (Pie) ---
    const ctxStatus = document.getElementById('graficoStatus').getContext('2d');
    const statusLabels = JSON.parse('{{ status_labels|safe }}');
    const statusData = JSON.parse('{{ status_data|safe }}');

    const statusColorMap = {
        'Novo':       { light: '--bs-secondary', dark: '--bs-secondary-text-emphasis' },
        'Em Contato': { light: '--bs-warning',   dark: '--bs-warning-text-emphasis'   },
        'Negociando': { light: '--bs-info',      dark: '--bs-info-text-emphasis'      },
        'Convertido': { light: '--bs-success',   dark: '--bs-success-text-emphasis'   },
        'Perdido':    { light: '--bs-danger',    dark: '--bs-danger-text-emphasis'    }
    };

    // ★ ALTERAÇÃO PRINCIPAL: Função centralizada para definir as cores da pizza
    function updatePieChartColors(chart) {
        // 1. Detecta se o modo escuro está ativo
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';

        // 2. Gera os arrays de cores com a lógica de inversão
        const backgroundColors = statusLabels.map(label => {
            const mapEntry = statusColorMap[label] || statusColorMap['Novo'];
            // Se for dark mode, usa a cor 'dark'. Senão, usa a cor 'light'.
            const varName = isDarkMode ? mapEntry.dark : mapEntry.light;
            return getCssVar(varName);
        });

        // ★ ALTERAÇÃO: A cor da borda agora é sempre a mesma, adaptável ao tema
        // Isso cria um efeito de "recorte" limpo que funciona em ambos os modos.
        const borderColor = getCssVar('--chart-pie-border-color');

        chart.data.datasets[0].backgroundColor = backgroundColors;
        chart.data.datasets[0].borderColor = borderColor; // Aplicado a todas as fatias
        chart.options.plugins.legend.labels.color = getCssVar('--chart-text-color');
        chart.update();
    }

    let activeSliceIndex = null;
    const pieChart = new Chart(ctxStatus, {
        type: 'pie',
        data: {
            labels: statusLabels,
            datasets: [{
                label: 'Leads por Status',
                data: statusData,
                // Os arrays de cores serão preenchidos pela nossa função
                backgroundColor: [],
                borderColor: [],
                borderWidth: 3, // Aumentei um pouco a borda para destacar o efeito
                offset: new Array(statusData.length).fill(0),
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: (event, elements) => {
                if (elements.length === 0) {
                    // Clicou fora de uma fatia, não faz nada
                    return;
                }

                const clickedIndex = elements[0].index;
                const offsetArray = pieChart.data.datasets[0].offset;

                // Lógica de toggle:
                // Se clicou na mesma fatia que já estava ativa, a recolhe.
                if (clickedIndex === activeSliceIndex) {
                    offsetArray[clickedIndex] = 0;
                    activeSliceIndex = null;
                } else {
                    // Se clicou em uma nova fatia:
                    // 1. Recolhe a fatia que estava ativa anteriormente (se houver)
                    if (activeSliceIndex !== null) {
                        offsetArray[activeSliceIndex] = 0;
                    }
                    // 2. Destaca a nova fatia
                    offsetArray[clickedIndex] = 20; // O valor do deslocamento em pixels
                    activeSliceIndex = clickedIndex;
                }

                // Atualiza o gráfico para mostrar a mudança
                pieChart.update();
            },
            plugins: {
                legend: {
                    position: window.innerWidth < 768 ? 'bottom' : 'right',
                    labels: {
                        padding: 10,
                        color: getCssVar('--chart-text-color')
                    }
                },
                tooltip: { enabled: true }
            }
        }
    });

    // ★ CHAMA A FUNÇÃO PELA PRIMEIRA VEZ para definir as cores iniciais
    updatePieChartColors(pieChart);

    // --- Observador de Tema ---
    const themeObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'data-bs-theme') {
                // Atualiza o gráfico de barras (lógica anterior)
                barChart.options.scales.y.ticks.color = getCssVar('--chart-text-color');
                barChart.options.scales.x.ticks.color = getCssVar('--chart-text-color');
                barChart.options.scales.y.grid.color = getCssVar('--chart-grid-color');
                barChart.update();

                // ★ CHAMA A MESMA FUNÇÃO para atualizar a pizza quando o tema muda
                updatePieChartColors(pieChart);
            }
        });
    });

    themeObserver.observe(document.documentElement, { attributes: true });

});
</script>
{% endblock %}