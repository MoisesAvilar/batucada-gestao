{% extends "scheduler/base.html" %}

{% block content %}

{# ★★★ CSS APRIMORADO COM VARIÁVEIS PARA LIGHT/DARK MODE ★★★ #}
<style>
    body {
        background-color: var(--bs-body-bg);
    }
    .initials-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background-color: var(--bs-primary-bg-subtle);
        color: var(--bs-emphasis-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.5rem;
    }
    .content-block {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        padding: 1.5rem;
        border-radius: 0.75rem;
    }
    .kpi-card {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        border-radius: 0.75rem;
        padding: 1rem;
    }
    .kpi-card .icon {
        font-size: 1.75rem;
    }
    .kpi-card .value {
        font-size: 1.75rem;
        font-weight: 700;
    }
    .list-group-item {
        background-color: transparent;
        border-color: var(--bs-border-color-translucent);
    }
    .progress {
        height: 10px;
    }
    
    @media (min-width: 992px) {
        .sticky-lg-top {
            position: sticky;
            top: 1.5rem;
            z-index: 1010;
        }
    }
</style>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="vstack gap-4">
            <div class="row g-3">
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="icon text-success-emphasis"><i class="bi bi-check2-circle"></i></div>
                        <div class="value mt-2">{{ total_realizadas }}</div>
                        <div class="text-muted small">Realizadas</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="icon text-warning-emphasis"><i class="bi bi-person-x"></i></div>
                        <div class="value mt-2">{{ total_aluno_ausente }}</div>
                        <div class="text-muted small">Ausências</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="icon text-danger-emphasis"><i class="bi bi-x-octagon"></i></div>
                        <div class="value mt-2">{{ total_canceladas }}</div>
                        <div class="text-muted small">Canceladas</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="icon text-secondary-emphasis"><i class="bi bi-journal-bookmark"></i></div>
                        <div class="value mt-2">{{ total_aulas }}</div>
                        <div class="text-muted small">Total</div>
                    </div>
                </div>
            </div>

            <div class="content-block">
                <h5 class="mb-0">Evolução de BPM por Exercício</h5>
                 {% if evolucao_chart_datasets %}
                    <p class="text-muted small">Baseado em {{ evolucao_total_aulas }} aula{{ evolucao_total_aulas|pluralize:"s" }} com prática registrada.</p>
                    <div class="mt-3" style="height: 350px;"><canvas id="studentEvolutionChart"></canvas></div>
                {% else %}
                    <div class="text-center text-muted p-5">Nenhum dado de evolução encontrado.</div>
                {% endif %}
            </div>

            <div class="content-block">
                <h5 class="mb-3">Histórico de Aulas</h5>
                {% include 'scheduler/partials/aula_table.html' with aulas=aulas_do_aluno %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="sticky-lg-top">
            <div class="vstack gap-4">
                <div class="content-block">
                    <div class="text-center">
                        <div class="initials-avatar mx-auto mb-3">{{ aluno.nome_completo|first|upper }}</div>
                        <h2 class="h4 mb-1">{{ aluno.nome_completo|title }}</h2>
                        {% if aluno.email %}
                         <p class="text-muted">{{ aluno.email }}</p>
                        {% else %}
                         <p class="text-muted">Email não informado</p>
                        {% endif %}
                    </div>

                    <hr>
                    
                    <div>
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small fw-bold">Taxa de Presença</span>
                            <span class="small fw-bold text-success">{{ taxa_presenca|floatformat:1 }}%</span>
                        </div>
                        <div class="progress" title="{{ taxa_presenca|floatformat:1 }}%">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ taxa_presenca|floatformat:0 }}%;" aria-valuenow="{{ taxa_presenca|floatformat:0 }}"></div>
                        </div>
                    </div>

                    {% if user.tipo == 'admin' %}
                    <div class="d-grid gap-2 mt-4">
                        <a href="{% url 'scheduler:aluno_editar' aluno.pk %}" class="btn btn-primary"><i class="bi bi-pencil-square me-1"></i> Editar Aluno</a>

                        <button type="button" id="btn-gerar-relatorio-ia" class="btn btn-success" data-aluno-id="{{ aluno.pk }}">
                            <i class="bi bi-robot me-1"></i> Gerar Análise com IA
                        </button>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" ...>Excluir</button>
                    </div>
                    {% endif %}
                </div>

                <div class="content-block">
                    <h6 class="mb-3">Distribuição de Status</h6>
                    <div style="height: 250px;"><canvas id="statusChart"></canvas></div>
                </div>

                <div class="content-block">
                    <h6 class="mb-3">Top Professores</h6>
                    <ul class="list-group list-group-flush">
                        {% for prof in top_professores %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <a href="{% url 'scheduler:professor_detalhe' prof.professores__pk %}" class="text-decoration-none text-body">{{ prof.professores__username|title }}</a>
                            <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{{ prof.contagem }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item px-0 text-muted small">Nenhum professor recorrente.</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="content-block">
                    <h6 class="mb-3">Top Categorias</h6>
                     <ul class="list-group list-group-flush">
                        {% for modalidade in top_modalidades %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span>{{ modalidade.modalidade__nome|title }}</span>
                            <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{{ modalidade.contagem }}</span>
                        </li>
                        {% empty %}
                        <li class="list-group-item px-0 text-muted small">Nenhuma categoria recorrente.</li>
                        {% endfor %}
                    </ul>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="iaReportModal" tabindex="-1" aria-labelledby="iaReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="iaReportModalLabel">Análise de Desempenho de {{ aluno.nome_completo|title }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="ia-report-content">
        <div class="text-center p-5" id="ia-loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Analisando...</span>
            </div>
            <p class="mt-3 text-muted">Aguarde, a IA está analisando os relatórios...</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}


{% block extra_js %}
{{ block.super }}

{# Passando dados para o JavaScript de forma segura (sem alterações aqui) #}
{{ chart_labels|json_script:"status-chart-labels-data" }}
{{ chart_data|json_script:"status-chart-data-data" }}
{{ evolucao_chart_labels|json_script:"evolucao-labels-data" }}
{{ evolucao_chart_datasets|json_script:"evolucao-datasets-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ★★★ INÍCIO DO SCRIPT DE GRÁFICOS COM TEMA INTELIGENTE E REATIVO ★★★
    let statusChartInstance = null;
    let evolutionChartInstance = null;

    function getChartThemeColors() {
        const rootStyles = getComputedStyle(document.documentElement);
        const theme = document.documentElement.getAttribute('data-bs-theme') || 'light';
        const isDark = theme === 'dark';

        return {
            fontColor: rootStyles.getPropertyValue('--bs-body-color').trim(),
            gridColor: rootStyles.getPropertyValue('--bs-border-color-translucent').trim(),
            // Cores para o gráfico de pizza (Realizadas, Ausências, Canceladas, Agendadas)
            pieColors: isDark 
                ? ['#198754', '#ffc107', '#dc3545', '#0dcaf0']
                : ['#198754', '#ffc107', '#dc3545', '#0dcaf0']
        };
    }

    // ★★★ FUNÇÃO ATUALIZADA COM AMBOS OS GRÁFICOS ★★★
    function renderOrUpdateCharts() {
        // Destrói instâncias antigas para redesenhar
        if (statusChartInstance) statusChartInstance.destroy();
        if (evolutionChartInstance) evolutionChartInstance.destroy();

        const themeColors = getChartThemeColors();
        Chart.defaults.color = themeColors.fontColor;
        
        // ===============================================
        //  1. GRÁFICO DE PIZZA (DISTRIBUIÇÃO DE STATUS)
        // ===============================================
        const statusLabelsDataEl = document.getElementById('status-chart-labels-data');
        const statusDataDataEl = document.getElementById('status-chart-data-data');
        const statusCtx = document.getElementById('statusChart');

        if (statusCtx && statusLabelsDataEl && statusDataDataEl) {
            const statusLabels = JSON.parse(statusLabelsDataEl.textContent);
            const statusData = JSON.parse(statusDataDataEl.textContent);
            
            // Só renderiza o gráfico se houver dados
            const hasData = statusData.some(item => item > 0);

            if (hasData) {
                statusChartInstance = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            label: 'Status',
                            data: statusData,
                            backgroundColor: themeColors.pieColors,
                            borderColor: 'var(--bs-tertiary-bg)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    boxWidth: 12
                                }
                            }
                        }
                    }
                });
            }
        }

        // ===============================================
        //  2. GRÁFICO DE LINHA (EVOLUÇÃO DE BPM)
        // ===============================================
        const evolutionLabelsData = document.getElementById('evolucao-labels-data');
        const evolutionDatasetsData = document.getElementById('evolucao-datasets-data');
        const evolutionCtx = document.getElementById('studentEvolutionChart');

        if (evolutionCtx && evolutionLabelsData && evolutionDatasetsData) {
            const labels = JSON.parse(evolutionLabelsData.textContent);
            const datasets = JSON.parse(evolutionDatasetsData.textContent);

            if (labels.length > 0 && datasets.length > 0) {
                Chart.defaults.borderColor = themeColors.gridColor;
                evolutionChartInstance = new Chart(evolutionCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'category',
                                title: {
                                    display: true,
                                    text: 'Data da Aula'
                                }
                            },
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'BPM (Batidas por Minuto)'
                                }
                            }
                        },
                        plugins: {
                            legend: { display: true, position: 'bottom' },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }
        }
    }
    // ★★★ FIM DA FUNÇÃO ATUALIZADA ★★★


    // Renderiza os gráficos na carga inicial da página
    renderOrUpdateCharts();

    // Observador para o modo light/dark (sem alterações aqui)
    const themeObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                renderOrUpdateCharts();
            }
        }
    });
    themeObserver.observe(document.documentElement, { attributes: true });

    const reportButton = document.getElementById('btn-gerar-relatorio-ia');
    if (reportButton) {
        reportButton.addEventListener('click', function() {
            const alunoId = this.dataset.alunoId;
            const reportModal = new bootstrap.Modal(document.getElementById('iaReportModal'));
            const reportContent = document.getElementById('ia-report-content');
            
            // ★★★ CORREÇÃO AQUI ★★★
            // Movemos a captura do HTML do spinner para dentro do evento de clique,
            // e adicionamos uma verificação para garantir que ele existe.
            const loadingSpinner = document.getElementById('ia-loading-spinner');
            if (loadingSpinner) {
                reportContent.innerHTML = loadingSpinner.outerHTML;
            } else {
                reportContent.innerHTML = '<p>Carregando...</p>'; // Fallback
            }
            // ★★★ FIM DA CORREÇÃO ★★★

            reportModal.show();

            const url = `/alunos/${alunoId}/gerar-relatorio-ia/`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || `Erro no servidor: ${response.statusText}`);
                    }).catch(() => {
                        throw new Error(`Erro na rede ou servidor: ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.report_html) {
                    reportContent.innerHTML = data.report_html;
                } else {
                    reportContent.innerHTML = `<div class="alert alert-warning">${data.error || 'Não foi possível gerar o relatório.'}</div>`;
                }
            })
            .catch(error => {
                reportContent.innerHTML = `<div class="alert alert-danger">Falha na requisição: ${error.message}</div>`;
            });
        });
    }
});
</script>
{% endblock %}