{% extends "scheduler/base.html" %}

{% block content %}

{# ★★★ 1. ADICIONADO CSS DO SELECT2 (NECESSÁRIO PARA O FILTRO) ★★★ #}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<style>
    .content-block {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        padding: 1.5rem;
        border-radius: 0.75rem;
    }
    .initials-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: var(--bs-primary-bg-subtle);
        color: var(--bs-emphasis-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
    }
    .date-group-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--bs-body-bg);
        padding-top: 1rem;
    }
    .date-group-header h4 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        margin-bottom: 0.5rem;
        border-bottom: 1px solid var(--bs-border-color-translucent);
        padding-bottom: 0.5rem;
        padding-left: 0.5rem;
    }
    .aula-card-status-badge {
        font-size: 0.8rem;
        font-weight: 600;
    }
    /* Garante que o dropdown do filtro apareça sobre o offcanvas */
    .select2-container--open {
        z-index: 1100 !important;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
        <h1 class="h3 mb-0">{{ titulo }}</h1>
        <p class="text-muted mb-0 d-none d-md-block">Filtre e visualize o histórico completo de aulas.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">
            <i class="bi bi-funnel me-1"></i> Filtros
        </button>
        {% if user.tipo == 'admin' %}
        <div class="dropdown">
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'scheduler:aula_agendar' %}"><i class="bi bi-plus-circle me-2"></i>Agendar Nova Aula</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Exportar com Filtros Atuais</h6></li>
                <li><a class="dropdown-item" href="{% url 'scheduler:exportar_aulas' %}?{{ request.GET.urlencode }}"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Detalhes</a></li>
                <li><a class="dropdown-item" href="{% url 'scheduler:exportar_relatorio_agregado' %}?{{ request.GET.urlencode }}"><i class="bi bi-file-earmark-bar-graph me-2"></i>Exportar Resumo</a></li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="filtersOffcanvasLabel"><i class="bi bi-funnel-fill me-2"></i>Filtros Avançados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
        <form method="GET" action="{{ request.path }}" id="filter-form" class="flex-grow-1">
             <div class="d-flex flex-wrap gap-2 mb-4">
                <button type="button" class="btn btn-sm btn-outline-primary flex-fill" id="filter-today">Hoje</button>
                <button type="button" class="btn btn-sm btn-outline-primary flex-fill" id="filter-week">Semana</button>
                <button type="button" class="btn btn-sm btn-outline-primary flex-fill" id="filter-month">Mês</button>
            </div>
            
            <div class="mb-3"><label for="id_data_inicial" class="form-label small fw-bold">Data Inicial</label><input type="date" id="id_data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial }}"></div>
            <div class="mb-3"><label for="id_data_final" class="form-label small fw-bold">Data Final</label><input type="date" id="id_data_final" name="data_final" class="form-control" value="{{ data_final }}"></div>
            {% if user.tipo == 'admin' %}<div class="mb-3"><label for="id_professor_filtro" class="form-label small fw-bold">Professor</label><select id="id_professor_filtro" name="professor_filtro" class="form-select"><option value="">Todos</option>{% for prof in professores_list %}<option value="{{ prof.pk }}" {% if prof.pk|stringformat:"d" == professor_filtro %}selected{% endif %}>{{ prof.username|title }}</option>{% endfor %}</select></div>{% endif %}
            <div class="mb-3"><label for="id_modalidade_filtro" class="form-label small fw-bold">Categoria</label><select id="id_modalidade_filtro" name="modalidade_filtro" class="form-select"><option value="">Todas</option>{% for modalidade in modalidades_list %}<option value="{{ modalidade.id }}" {% if modalidade.id|stringformat:"d" == modalidade_filtro %}selected{% endif %}>{{ modalidade.nome|title }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label for="id_aluno_filtro" class="form-label small fw-bold">Aluno(s)</label><select id="id_aluno_filtro" name="aluno_filtro" class="form-select" multiple>{% for aluno in alunos_list %}<option value="{{ aluno.pk }}" {% if aluno.pk in aluno_filtro_ids %}selected{% endif %}>{{ aluno.nome_completo|title }}</option>{% endfor %}</select></div>
            <div class="mb-3"><label for="id_status_filtro" class="form-label small fw-bold">Status</label><select id="id_status_filtro" name="status_filtro" class="form-select"><option value="">Todos</option>{% for status_value, status_label in status_choices %}<option value="{{ status_value }}" {% if status_value == status_filtro %}selected{% endif %}>{{ status_label }}</option>{% endfor %}<option value="Substituído" {% if 'Substituído' == status_filtro %}selected{% endif %}>Substituído</option><option value="professor_ausente" {% if 'professor_ausente' == status_filtro %}selected{% endif %}>Professor Ausente (AC)</option></select></div>

            <div class="mt-auto pt-3 border-top"><div class="d-flex gap-2"><a href="{{ request.path }}" class="btn btn-outline-secondary w-100">Limpar</a><button class="btn btn-primary w-100" type="submit">Aplicar Filtros</button></div></div>
        </form>
    </div>
</div>

<div class="aulas-feed">
    {% if not aulas %}
        <div class="text-center text-muted p-5 content-block">
            <h4><i class="bi bi-search-heart"></i></h4>
            <p class="mb-0">Nenhuma aula encontrada para os filtros aplicados.</p>
        </div>
    {% else %}
        {% regroup aulas by data_hora.date as aulas_por_dia %}
        {% for grupo in aulas_por_dia %}
            <div class="date-group-header">
                <h4 class="h5 mb-3">{{ grupo.grouper|date:"l, d \d\e F \d\e Y"|capfirst }}</h4>
            </div>
            <div class="vstack gap-3">
            {% for aula in grupo.list %}
                {% include 'scheduler/partials/aula_card.html' with aula=aula %}
            {% endfor %}
            </div>
        {% endfor %}
    {% endif %}
</div>

{% include 'scheduler/partials/pagination.html' with page_obj=page_obj request=request %}

{% endblock %}


{% block extra_js %}
{{ block.super }}

{# ★★★ 2. ADICIONADO SCRIPT DO SELECT2 (NECESSÁRIO PARA O FILTRO) ★★★ #}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa o Select2 para o filtro de alunos
    $('#id_aluno_filtro').select2({
        theme: 'bootstrap-5',
        placeholder: 'Selecione um ou mais alunos',
        closeOnSelect: false,
        // Garante que o dropdown do select2 apareça dentro do painel de filtros (offcanvas)
        dropdownParent: $('#filtersOffcanvas')
    });

    // Lógica dos botões de filtro de data (já existente)
    const form = document.getElementById('filter-form');
    if (!form) return;

    const dateStartInput = form.querySelector('#id_data_inicial');
    const dateEndInput = form.querySelector('#id_data_final');
    
    function formatDate(date) { return date.toISOString().split('T')[0]; }

    document.getElementById('filter-today')?.addEventListener('click', () => {
        const today = formatDate(new Date());
        dateStartInput.value = today;
        dateEndInput.value = today;
        form.submit();
    });

    document.getElementById('filter-week')?.addEventListener('click', () => {
        const today = new Date();
        const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
        const lastDay = new Date(new Date(firstDay).setDate(firstDay.getDate() + 6));
        dateStartInput.value = formatDate(firstDay);
        dateEndInput.value = formatDate(lastDay);
        form.submit();
    });

    document.getElementById('filter-month')?.addEventListener('click', () => {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        dateStartInput.value = formatDate(firstDay);
        dateEndInput.value = formatDate(lastDay);
        form.submit();
    });
});
</script>
{% endblock %}