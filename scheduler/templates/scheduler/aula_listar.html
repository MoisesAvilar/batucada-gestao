{% extends "scheduler/base.html" %}

{% block content %}

{# 1. Dependências de CSS (pode até ir para o base.html se for usar em muitos lugares) #}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
    /* Estilos da página (mantidos como antes) */
    .content-block { background-color: var(--bs-tertiary-bg); border: 1px solid var(--bs-border-color-translucent); padding: 1.5rem; border-radius: 0.75rem; }
    .initials-avatar { width: 28px; height: 28px; border-radius: 50%; background-color: var(--bs-primary-bg-subtle); color: var(--bs-emphasis-color); display: inline-flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.8rem; }
    .date-group-header { position: sticky; top: 0; z-index: 10; background-color: var(--bs-body-bg); padding-top: 1rem; }
    .date-group-header h4 { font-size: 1.25rem; font-weight: 600; color: var(--bs-secondary-color); margin-bottom: 0.5rem; border-bottom: 1px solid var(--bs-border-color-translucent); padding-bottom: 0.5rem; padding-left: 0.5rem; }
    .aula-card-status-badge { font-size: 0.8rem; font-weight: 600; }
    .select2-container--open { z-index: 1100 !important; }
</style>

{# 2. Cabeçalho da página (inalterado) #}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
        <h1 class="h3 mb-0">{{ titulo }}</h1>
        <p class="text-muted mb-0 d-none d-md-block">Filtre e visualize o histórico completo de aulas.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">
            <i class="bi bi-funnel me-1"></i> Filtros
        </button>
        {% if user.tipo == 'admin' %}
        <div class="dropdown">
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'scheduler:aula_agendar' %}"><i class="bi bi-plus-circle me-2"></i>Agendar Nova Aula</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><h6 class="dropdown-header">Exportar com Filtros Atuais</h6></li>
                <li><a class="dropdown-item" href="{% url 'scheduler:exportar_aulas' %}?{{ request.GET.urlencode }}"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Detalhes</a></li>
                <li><a class="dropdown-item" href="{% url 'scheduler:exportar_relatorio_agregado' %}?{{ request.GET.urlencode }}"><i class="bi bi-file-earmark-bar-graph me-2"></i>Exportar Resumo</a></li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

{# 3. INCLUSÃO DO COMPONENTE DE FILTRO #}
{% include 'scheduler/partials/_filter_panel.html' with form_action=request.path request=request user=user data_inicial=data_inicial data_final=data_final professores_list=professores_list modalidades_list=modalidades_list alunos_list=alunos_list status_choices=status_choices professor_filtro=professor_filtro modalidade_filtro=modalidade_filtro aluno_filtro_ids=aluno_filtro_ids status_filtro=status_filtro %}

{# 4. Feed de aulas (inalterado) #}
<div class="aulas-feed">
    {% if not aulas %}
        <div class="text-center text-muted p-5 content-block">
            <h4><i class="bi bi-search-heart"></i></h4>
            <p class="mb-0">Nenhuma aula encontrada para os filtros aplicados.</p>
        </div>
    {% else %}
        {% regroup aulas by data_hora.date as aulas_por_dia %}
        {% for grupo in aulas_por_dia %}
            <div class="date-group-header">
                <h4 class="h5 mb-3">{{ grupo.grouper|date:"l, d \d\e F \d\e Y"|capfirst }}</h4>
            </div>
            <div class="vstack gap-3">
            {% for aula in grupo.list %}
                {% include 'scheduler/partials/aula_card.html' with aula=aula %}
            {% endfor %}
            </div>
        {% endfor %}
    {% endif %}
</div>

{% include 'scheduler/partials/pagination.html' with page_obj=page_obj request=request %}

{% endblock %}


{% block extra_js %}
{{ block.super }}
{# 5. INCLUSÃO DO SCRIPT DO COMPONENTE DE FILTRO #}
{% include 'scheduler/partials/_filter_panel_js.html' %}
{% endblock %}