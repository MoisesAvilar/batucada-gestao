{% extends "scheduler/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>{{ titulo }}</h1>
  <div>
    {% if user.tipo == 'admin' %}
      <a href="{% url 'scheduler:aula_agendar' %}" class="btn btn-primary me-2"><i class="bi bi-plus-circle"></i> Agendar Aula</a>
      {# O botão de exportar agora passa todos os filtros atuais de forma dinâmica #}
      <a href="{% url 'scheduler:exportar_aulas' %}{% if request.GET.urlencode %}?{{ request.GET.urlencode }}{% endif %}" class="btn btn-success">
        <i class="bi bi-file-earmark-arrow-down"></i> Exportar
      </a>
    {% endif %}
  </div>
</div>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}

<div class="card p-3 shadow-sm mb-4">
    <form method="GET" action="{% url 'scheduler:aula_listar' %}"> 
        <div class="row g-3 align-items-end">
            <div class="col-md-12 col-lg-4">
                <label for="id_q" class="form-label">Busca por Termo</label> 
                <input type="text" id="id_q" name="q" class="form-control" placeholder="Aluno, professor..." value="{{ search_query }}">
            </div>
            <div class="col-md-6 col-lg-2">
                <label for="id_data_inicial" class="form-label">De:</label>
                <input type="date" id="id_data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial }}">
            </div>
            <div class="col-md-6 col-lg-2">
                <label for="id_data_final" class="form-label">Até:</label>
                <input type="date" id="id_data_final" name="data_final" class="form-control" value="{{ data_final }}">
            </div>
            {% if user.tipo == 'admin' %}
            <div class="col-md-4 col-lg-4">
                <label for="id_professor_filtro" class="form-label">Professor</label>
                <select id="id_professor_filtro" name="professor_filtro" class="form-select">
                    <option value="">Todos</option>
                    {% for prof in professores_list %}<option value="{{ prof.pk }}" {% if prof.pk|stringformat:"s" == professor_filtro %}selected{% endif %}>{{ prof.username|title }}</option>{% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-4 col-lg-4">
                <label for="id_modalidade_filtro" class="form-label">Modalidade</label>
                <select id="id_modalidade_filtro" name="modalidade_filtro" class="form-select">
                    <option value="">Todas</option>
                    {% for modalidade in modalidades_list %}<option value="{{ modalidade.id }}" {% if modalidade.id|stringformat:"s" == modalidade_filtro %}selected{% endif %}>{{ modalidade.nome|title }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-4 col-lg-4">
                <label for="id_status_filtro" class="form-label">Status</label>
                <select id="id_status_filtro" name="status_filtro" class="form-select">
                    <option value="">Todos</option>
                    {% for value, label in status_choices %}<option value="{{ value }}" {% if value == status_filtro %}selected{% endif %}>{{ label }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-12 d-flex justify-content-end mt-3">
                <button class="btn btn-primary me-2" type="submit"><i class="bi bi-filter"></i> Filtrar</button>
                <a href="{% url 'scheduler:aula_listar' %}" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Limpar</a>
            </div>
        </div>
    </form>
</div>
<div class="row mb-4">
    <div class="col-md-3"><div class="card text-center text-bg-secondary"><div class="card-body"><h5 class="card-title">Total de Aulas no Filtro</h5><p class="card-text fs-4 fw-bold">{{ total_aulas_filtradas }}</p></div></div></div>
    <div class="col-md-3"><div class="card text-center text-bg-success"><div class="card-body"><h5 class="card-title">Aulas Realizadas</h5><p class="card-text fs-4 fw-bold">{{ total_realizadas_filtradas }}</p></div></div></div>
    <div class="col-md-3"><div class="card text-center text-bg-warning"><div class="card-body"><h5 class="card-title">Alunos Ausentes</h5><p class="card-text fs-4 fw-bold">{{ total_ausentes_filtradas }}</p></div></div></div>
    <div class="col-md-3"><div class="card text-center text-bg-danger"><div class="card-body"><h5 class="card-title">Aulas Canceladas</h5><p class="card-text fs-4 fw-bold">{{ total_canceladas_filtradas }}</p></div></div></div>
</div>
<div class="card shadow-sm">
  <div class="card-body">
    {% include 'scheduler/partials/aula_table.html' with aulas=aulas %}
  </div>
</div>

{% endblock %}