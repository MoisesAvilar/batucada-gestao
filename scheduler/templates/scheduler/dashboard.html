{% extends "scheduler/base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>Dashboard</h1>
  {% if user.tipo == 'admin' %}
  <span class="badge bg-primary fs-6">Visão do Administrador</span>
  {% else %}
  <span class="badge bg-success fs-6">Visão do Professor</span>
  {% endif %}
</div>

<h4>Próximas Aulas Agendadas</h4>

{% if user.tipo == 'admin' %}
<a href="{% url 'scheduler:aula_agendar' %}" class="btn btn-primary mb-3"
  >Agendar Nova Aula</a

>
{% endif %}

{# BARRA DE BUSCA E FILTROS DE DATA #}
<div class="mb-3 card p-3 shadow-sm">
    <form method="GET" action="{% url 'scheduler:dashboard' %}" class="d-flex flex-wrap align-items-end"> 
        <div class="col-md-6 mb-2 mb-md-0"> 
            <label for="id_q" class="form-label">Termo de Busca</label> 
            <input type="text" id="id_q" name="q" class="form-control" placeholder="Aluno, professor, modalidade..." value="{{ search_query }}">
        </div>
        <div class="col-md-3 mb-2 mb-md-0">
            <label for="id_data_inicial" class="form-label">Data Inicial</label>
            <input type="date" id="id_data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial }}">
        </div>
        <div class="col-md-3">
            <label for="id_data_final" class="form-label">Data Final</label>
            <input type="date" id="id_data_final" name="data_final" class="form-control" value="{{ data_final }}">
        </div>

        <div class="col-12 d-flex justify-content-end mt-3">
            <button class="btn btn-outline-secondary me-2" type="submit">
                <i class="bi bi-search"></i> Buscar
            </button>
            {% if search_query or data_inicial or data_final %}
                <a href="{% url 'scheduler:dashboard' %}" class="btn btn-outline-danger">
                    <i class="bi bi-x-circle"></i> Limpar Filtros
                </a>
            {% endif %}
        </div>
    </form>
</div>
{# FIM BARRA DE BUSCA E FILTROS DE DATA #}

{% if messages %}
<div class="messages">
  {% for message in messages %}
  <div
    class="alert alert-{{ message.tags }} alert-dismissible fade show"
    role="alert"
  >
    {{ message }}
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="alert"
      aria-label="Close"
    ></button>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead>
      <tr>
        <th scope="col">
          <a href="?order_by=aluno&direction={% if order_by == 'aluno' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}" 
             class="text-decoration-none text-dark">
            Aluno
            {% if order_by == 'aluno' %}
              {% if direction == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}
            {% endif %}
          </a>
        </th>
        <th scope="col">
          <a href="?order_by=modalidade&direction={% if order_by == 'modalidade' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}" 
             class="text-decoration-none text-dark">
            Modalidade
            {% if order_by == 'modalidade' %}
              {% if direction == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}
            {% endif %}
          </a>
        </th>
        <th scope="col">
          <a href="?order_by=professor_atribuido&direction={% if order_by == 'professor_atribuido' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}" 
             class="text-decoration-none text-dark">
            Professor Atribuído
            {% if order_by == 'professor_atribuido' %}
              {% if direction == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}
            {% endif %}
          </a>
        </th>
        <th scope="col">
          <a href="?order_by=professor_realizou&direction={% if order_by == 'professor_realizou' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}" 
             class="text-decoration-none text-dark">
        Professor Realizou
        {% if order_by == 'professor_realizou' %}
          {% if direction == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}
        {% endif %}
      </a>
    </th>
    <th scope="col">
      <a href="?order_by=data_hora&direction={% if order_by == 'data_hora' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}" 
         class="text-decoration-none text-dark">
        Data e Hora
        {% if order_by == 'data_hora' %}
          {% if direction == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}
        {% endif %}
      </a>
    </th>
    <th scope="col">
      <a href="?order_by=status&direction={% if order_by == 'status' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}" 
         class="text-decoration-none text-dark">
        Status
        {% if order_by == 'status' %}
          {% if direction == 'asc' %}<i class="bi bi-caret-up-fill"></i>{% else %}<i class="bi bi-caret-down-fill"></i>{% endif %}
        {% endif %}
      </a>
    </th>
    <th scope="col" class="text-end">Ações</th>
  </tr>
</thead>
<tbody>
  {% for aula in aulas %}
  <tr>
    <td>
        <a href="{% url 'scheduler:aluno_detalhe' aula.aluno.pk %}">{{ aula.aluno.nome_completo|title }}</a>
    </td>
    <td>{{ aula.modalidade.nome|title }}</td>
    <td>
      {% if aula.professor %}
        <a href="{% url 'scheduler:professor_detalhe' aula.professor.pk %}" class="text-decoration-none text-dark">
          {% if user.tipo == 'professor' and aula.professor == request.user %}
            <span class="badge bg-primary">Eu</span>
          {% else %}
            {{ aula.professor.username|title }}
          {% endif %}
        </a>
      {% else %}
        Não Atribuído
      {% endif %}
    </td>
    <td>
      {% if aula.status == 'Realizada' and aula.relatorioaula.professor_que_validou %}
        <a href="{% url 'scheduler:professor_detalhe' aula.relatorioaula.professor_que_validou.pk %}" class="text-decoration-none text-dark">
          {% if user.tipo == 'professor' and aula.relatorioaula.professor_que_validou == request.user %}
            <span class="badge bg-primary">Eu</span>
          {% else %}
            {{ aula.relatorioaula.professor_que_validou.username|title }}
          {% endif %}
        </a>
      {% else %}
        <span class="text-muted small">Aguardando Validação</span>
      {% endif %}
    </td>
    <td>{{ aula.data_hora|date:"d/m/Y, H:i" }}</td>
    <td>
      {% if aula.status == 'Agendada' %}
        <span class="badge bg-info text-dark">{{ aula.status }}</span>
      {% elif aula.status == 'Realizada' %}
        <span class="badge bg-success">{{ aula.status }}</span>
      {% elif aula.status == 'Cancelada' %}
        <span class="badge bg-danger">{{ aula.status }}</span>
      {% elif aula.status == 'Aluno Ausente' %}
        <span class="badge bg-warning text-dark">{{ aula.status }}</span>
      {% else %}
        <span class="badge bg-secondary">{{ aula.status }}</span>
      {% endif %}
    </td>
    <td class="text-end">
      {% if user.tipo == 'admin' %}
        <a href="{% url 'scheduler:aula_editar' aula.pk %}" class="btn btn-sm btn-outline-primary" title="Editar Aula">
          <i class="bi bi-pencil-square"></i>
        </a>
        <a href="{% url 'scheduler:aula_validar' aula.pk %}" class="btn btn-sm btn-outline-info" title="Ver/Editar Relatório">
          <i class="bi bi-file-earmark-text"></i>
        </a>
        <a href="{% url 'scheduler:aula_excluir' aula.pk %}" class="btn btn-sm btn-outline-danger" title="Excluir">
          <i class="bi bi-trash"></i>
        </a>
      {% else %} {# É professor #}
        {% if aula.status == 'Agendada' %}
            {% if aula.professor == request.user %}
                <a href="{% url 'scheduler:aula_validar' aula.pk %}" class="btn btn-sm btn-success" title="Validar Minha Aula">
                    <i class="bi bi-check-circle"></i> Validar Aula
                </a>
            {% else %}
                <a href="{% url 'scheduler:aula_validar' aula.pk %}" class="btn btn-sm btn-warning" title="Substituir e Validar">
                    <i class="bi bi-person-replace"></i> Substituir
                </a>
            {% endif %}
        {% elif aula.status == 'Realizada' %}
            <a href="{% url 'scheduler:aula_validar' aula.pk %}" class="btn btn-sm btn-outline-info" title="Ver Relatório">
                <i class="bi bi-eye"></i> Ver Relatório
            </a>
        {% else %} {# Cancelada ou outro status #}
            <span class="text-muted small">N/A</span>
        {% endif %}
      {% endif %}
    </td>
  </tr>
  {% empty %}
  <tr>
    <td colspan="7" class="text-center text-muted py-4">Nenhuma aula agendada no momento.</td>
  </tr>
  {% endfor %}
</tbody>
</table>{# FECHA A TAG TABLE AQUI #}
</div>{# FECHA A TAG DIV table-responsive AQUI #}

{# Controles de Paginação #}
{% if aulas.has_other_pages %}
<nav aria-label="Navegação de Páginas">
  <ul class="pagination justify-content-center">
    {% if aulas.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ aulas.previous_page_number }}&order_by={{ order_by }}&direction={{ direction }}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}">Anterior</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Anterior</span>
      </li>
    {% endif %}

    {% for i in aulas.paginator.page_range %}
      {% if aulas.number == i %}
        <li class="page-item active" aria-current="page">
          <span class="page-link">{{ i }}</span>
        </li>
      {% else %}
        <li class="page-item">
          <a class="page-link" href="?page={{ i }}&order_by={{ order_by }}&direction={{ direction }}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}">{{ i }}</a>
        </li>
      {% endif %}
    {% endfor %}

    {% if aulas.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ aulas.next_page_number }}&order_by={{ order_by }}&direction={{ direction }}{% if search_query %}&q={{ search_query }}{% endif %}{% if data_inicial %}&data_inicial={{ data_inicial }}{% endif %}{% if data_final %}&data_final={{ data_final }}{% endif %}">Próximo</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Próximo</span>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %} {# FIM DA PAGINACAO #}

{# Calendário FullCalendar #}
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5>Visão de Agenda</h5>
    </div>
    <div class="card-body">
        <div id='fullcalendar'></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('fullcalendar');
        if (calendarEl) {
            // Lógica de responsividade
            var initialView = 'dayGridMonth';
            var headerToolbarConfig = {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            };

            // Ajusta para telas menores (ex: mobile)
            if (window.innerWidth < 768) {
                initialView = 'listWeek';
                headerToolbarConfig = {
                    left: 'prev,next',
                    center: 'title',
                    right: 'listWeek,dayGridMonth'
                };
            }

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: initialView,
                locale: 'pt-br',
                headerToolbar: headerToolbarConfig,
                height: 'auto', // Mantido para ajuste automático
                
                // --- NOVAS OPÇÕES PARA GERENCIAR EXIBIÇÃO E FUSO HORÁRIO ---
                eventOverlap: false, // Prevines que eventos se sobreponham visualmente no mesmo slot (útil para timeGrid)
                eventDisplay: 'block', // Garante que eventos sejam exibidos como blocos
                eventTimeFormat: { // Formato da hora no evento
                    hour: '2-digit',
                    minute: '2-digit',
                    meridiem: false // Não mostra AM/PM
                },
                slotMinTime: "06:00:00", // Horário mínimo exibido (útil para timeGrid)
                slotMaxTime: "23:00:00", // Horário máximo exibido

                // CORREÇÃO 1: Desativa o agrupamento "+N more", fazendo as células expandirem
                views: {
                    dayGridMonth: {
                        dayMaxEvents: false // <--- ALTERADO AQUI: false para expandir a célula
                    }
                },
                // --- FIM NOVAS OPÇÕES ---

                eventSources: [
                    {
                        url: "{% url 'scheduler:get_eventos_calendario' %}",
                        method: 'GET',
                        extraParams: function() { 
                            return {}; 
                        },
                        failure: function() {
                            alert('Houve um erro ao carregar os eventos do calendário!');
                        },
                        // CORREÇÃO 2: Informa ao FullCalendar que os eventos vêm em UTC
                        // Ele então converterá para o fuso horário local do navegador.
                        timezone: 'UTC', // <--- ADICIONADO AQUI: Eventos do backend são UTC
                        textColor: 'white' 
                    }
                ],
                eventClick: function(info) {
                    if (info.event.url) {
                        info.jsEvent.preventDefault(); 
                        window.open(info.event.url, '_blank'); 
                    }
                },
                dateClick: function(info) {
                    var isAdmin = {% if user.tipo == 'admin' %}true{% else %}false{% endif %};
                    if (isAdmin) {
                        var clickedDate = info.dateStr; 
                        window.location.href = "{% url 'scheduler:aula_agendar' %}?data_hora=" + clickedDate + "T08:00";
                    } else {
                        alert('Você não tem permissão para agendar aulas.');
                    }
                }
            });
            calendar.render();

            window.addEventListener('resize', function() {
                var currentViewName = calendar.view.type;
                var newInitialView = 'dayGridMonth';
                var newHeaderToolbarConfig = {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                };

                if (window.innerWidth < 768) {
                    newInitialView = 'listWeek';
                    newHeaderToolbarConfig = {
                        left: 'prev,next',
                        center: 'title',
                        right: 'listWeek,dayGridMonth'
                    };
                }

                if (currentViewName !== newInitialView) {
                    calendar.changeView(newInitialView);
                }
                calendar.setOption('headerToolbar', newHeaderToolbarConfig);
            });
        }
    });
</script>
{% endblock %}