{% extends "scheduler/base.html" %}

{% block content %}
{# --- CABEÇALHO --- #}
<div class="text-center mb-4">
    <h1 class="mb-1">{{ titulo }}</h1>
    {% if user.tipo == 'admin' %}
        <p class="text-muted mb-0">Visão geral do sistema e atalhos rápidos.</p>
    {% else %}
        <p class="text-muted mb-0">Resumo das suas atividades e agenda.</p>
    {% endif %}
</div>
{% if user.tipo == 'admin' %}
<div class="d-flex justify-content-center justify-content-md-end align-items-center gap-2 mb-4">
    <a href="{% url 'scheduler:relatorios_aulas' %}" class="btn btn-secondary"><i class="bi bi-bar-chart-line-fill me-1"></i> Relatórios</a>
    <a href="{% url 'scheduler:aula_agendar' %}" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i> Agendar Aula</a>
</div>
{% endif %}

{# --- VISÃO DO ADMINISTRADOR --- #}
{% if user.tipo == 'admin' %}
    {# Cards de Resumo #}
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-info shadow h-100"><div class="card-body"><div class="row g-0 align-items-center"><div class="col"><div class="small fw-bold text-uppercase mb-1">Aulas Hoje</div><div class="h3 mb-0 fw-bold">{{ aulas_hoje_count }}</div></div><div class="col-auto"><i class="bi bi-calendar-day fs-1 opacity-75"></i></div></div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-primary shadow h-100"><div class="card-body"><div class="row g-0 align-items-center"><div class="col"><div class="small fw-bold text-uppercase mb-1">Aulas na Semana</div><div class="h3 mb-0 fw-bold">{{ aulas_semana_count }}</div></div><div class="col-auto"><i class="bi bi-calendar-week fs-1 opacity-75"></i></div></div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-secondary shadow h-100"><div class="card-body"><div class="row g-0 align-items-center"><div class="col"><div class="small fw-bold text-uppercase mb-1">Total Agendadas</div><div class="h3 mb-0 fw-bold">{{ aulas_agendadas_total }}</div></div><div class="col-auto"><i class="bi bi-clock-history fs-1 opacity-75"></i></div></div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><a href="{% url 'scheduler:aluno_listar' %}?data_inicial={{ primeiro_dia_mes }}&data_final={{ ultimo_dia_mes }}" class="text-decoration-none"><div class="card text-bg-success shadow h-100 card-hover"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-uppercase mb-1">Novos Alunos (Este Mês)</div><div class="h5 mb-0 fw-bold">{{ novos_alunos_mes }}</div></div><div class="col-auto"><i class="bi bi-person-plus-fill fs-2 text-white-50"></i></div></div></div></div></a></div>
    </div>
    
    {# Calendário do Admin #}
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Visão Geral da Agenda</h5>
            <div class="ms-auto"><select id="professor_calendario_filtro" class="form-select form-select-sm"><option value="">Todos os Professores</option>{% for prof in professores_list %}<option value="{{ prof.id }}">{{ prof.username|title }}</option>{% endfor %}</select></div>
        </div>
        <div class="card-body"><div id='fullcalendar'></div></div>
    </div>
    
    {# Seção de Aulas de Hoje para o Admin #}
    {# --- SEÇÃO "AULAS DE HOJE" CORRIGIDA PARA ADMIN --- #}
<div class="card shadow-sm mt-4">
    <div class="card-header text-center py-3">
        <h5 class="mb-0">
            Aulas de Hoje
            <span class="badge bg-primary rounded-pill align-middle ms-1">{{ aulas_hoje_count }}</span>
        </h5>
        <small class="text-muted">
            {{ today|date:"l, d \d\e F"|capfirst }}
        </small>
    </div>
    <div class="card-body p-0">
        {% if aulas_do_dia %}
            {% include 'scheduler/partials/aula_table.html' with aulas=aulas_do_dia %}
        {% else %}
            <div class="text-center text-muted p-4">Nenhuma aula agendada para hoje no sistema.</div>
        {% endif %}
    </div>
</div>

{# --- VISÃO DO PROFESSOR --- #}
{% else %}
    {# Cards de Resumo do Professor #}
    <div class="row">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card text-bg-info shadow h-100">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col">
                            {# --- CORRIGIDO AQUI --- #}
                            <div class="small fw-bold text-uppercase mb-1">Minhas Aulas Hoje</div>
                            <div class="h3 mb-0 fw-bold">{{ aulas_hoje_count }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-calendar-day fs-1 opacity-75"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card text-bg-primary shadow h-100">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col">
                            <div class="small fw-bold text-uppercase mb-1">Minhas Aulas na Semana</div>
                            <div class="h3 mb-0 fw-bold">{{ aulas_semana_count }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-calendar-week fs-1 opacity-75"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card text-bg-danger shadow h-100">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col">
                            <div class="small fw-bold text-uppercase mb-1">Pendentes de Validação</div>
                            <div class="h3 mb-0 fw-bold">{{ aulas_pendentes_count }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-exclamation-triangle-fill fs-1 opacity-75"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Aulas Pendentes de Validação #}
    {% if aulas_pendentes_validacao %}
    <div class="card shadow-sm mb-4 border-danger">
        <div class="card-header bg-danger text-white"><h5><i class="bi bi-exclamation-triangle-fill"></i> Ação Necessária: Aulas Pendentes de Validação</h5></div>
        <div class="card-body">
            <p class="text-muted small">As aulas abaixo já ocorreram mas ainda não tiveram o relatório preenchido.</p>
            {% include 'scheduler/partials/aula_table.html' with aulas=aulas_pendentes_validacao %}
        </div>
    </div>
    {% endif %}

    {# Calendário do Professor #}
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5>Minha Agenda</h5></div>
        <div class="card-body"><div id='fullcalendar'></div></div>
    </div>
    
    {# Seção de Aulas de Hoje para o Professor #}
     <div class="card shadow-sm mb-4">
        <div class="card-header text-center py-3">
            <h5 class="mb-0">
                Minhas Aulas de Hoje
                <span class="badge bg-primary rounded-pill align-middle ms-1">{{ aulas_hoje_count }}</span>
            </h5>
            <small class="text-muted">
                {{ today|date:"l, d \d\e F"|capfirst }}
            </small>
        </div>
        <div class="card-body p-0">
            {% if aulas_do_dia %}
                {% include 'scheduler/partials/aula_table.html' with aulas=aulas_do_dia %}
            {% else %}
                <div class="text-center text-muted p-4">Você não tem aulas agendadas para hoje.</div>
            {% endif %}
        </div>
    </div>
{% endif %}
{% if user.tipo == 'admin' %}
    <div class="modal fade" id="agendamentoModal" tabindex="-1" aria-labelledby="agendamentoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="agendamentoModalLabel">Agendar Nova Aula</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            {# Inclui o nosso novo formulário parcial #}
            {% include 'scheduler/partials/aula_form_content.html' with form=aula_form_modal aluno_formset=aluno_formset_modal professor_formset=professor_formset_modal form_action=form_action_modal %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<!-- SCRIPTS NECESSÁRIOS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('fullcalendar');
    if (!calendarEl) return;

    const isMobile = window.innerWidth < 768;

    const statusColorMap = {
        'Realizada': 'success',
        'Agendada': 'info',
        'Cancelada': 'danger',
        'Aluno Ausente': 'warning'
    };

    const toTitleCase = (str) => {
        if (!str) return '';
        return str.toLowerCase().split(' ').map(word =>
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join(' ');
    };

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: isMobile ? 'listWeek' : 'dayGridMonth',
        headerToolbar: isMobile
            ? { left: 'title', center: '', right: 'listWeek,dayGridMonth prev,next' }
            : { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },

        views: {
            dayGridMonth: { titleFormat: { year: 'numeric', month: 'long' } },
            timeGridWeek: { titleFormat: { day: 'numeric', month: 'short' } },
            listWeek: { titleFormat: { day: 'numeric', month: 'short' } },
        },

        locale: 'pt-br',
        height: 'auto',
        buttonText: {
            today: 'Hoje',
            month: 'Mês',
            week: 'Semana',
            day: 'Dia',
            listWeek: 'Lista'
        },
        noEventsContent: "📭 Nenhuma aula encontrada para este período.",
        allDayText: 'Dia Inteiro',

        eventMouseEnter: function (info) {
            const status = info.event.extendedProps.status;
            const badgeClass = statusColorMap[status] || 'secondary';
            const textColorClass = ['warning', 'info'].includes(badgeClass) ? 'text-dark' : '';

            try {
                const popover = new bootstrap.Popover(info.el, {
                    title: toTitleCase(info.event.extendedProps.modalidade || ''),
                    content: `
                        <strong>Aluno:</strong> ${toTitleCase(info.event.extendedProps.aluno || '')}<br>
                        <strong>Status:</strong> <span class="badge ${textColorClass} bg-${badgeClass}">${status}</span><br>
                        <strong>Prof. Atribuído:</strong> ${toTitleCase(info.event.extendedProps.professor_atribuido || '')}
                    `,
                    placement: 'top',
                    html: true,
                    container: 'body'
                });
                info.el.bsPopover = popover;
                popover.show();
            } catch (err) {
                console.warn("Erro ao exibir popover:", err);
            }
        },

        eventMouseLeave: function (info) {
            try {
                if (info.el.bsPopover) {
                    info.el.bsPopover.dispose();
                    info.el.bsPopover = null;
                }
            } catch (err) {
                console.warn("Erro ao remover popover:", err);
            }
        },

        eventClick: function (info) {
            if (info.event.url) {
                info.jsEvent.preventDefault();
                window.location.href = info.event.url;
            }
        },

        dateClick: function (info) {
            {% if user.tipo == 'admin' %}
            const modalEl = document.getElementById('agendamentoModal');
            const form = modalEl?.querySelector('form');
            const inputDataHora = form?.querySelector('#id_data_hora');
            if (modalEl && form && inputDataHora) {
                inputDataHora.value = info.dateStr + "T08:00";
                bootstrap.Modal.getOrCreateInstance(modalEl).show();
            }
            {% endif %}
        },

        eventSources: [{
            url: "{% url 'scheduler:get_eventos_calendario' %}",
            extraParams: function () {
                const filtroEl = document.getElementById('professor_calendario_filtro');
                return { professor_filtro_id: filtroEl?.value || "" };
            },
            failure: function () {
                alert("Erro ao carregar eventos do calendário.");
            }
        }]
    });

    calendar.render();

    // Recarrega eventos ao trocar o filtro (admin)
    const profFiltroEl = document.getElementById('professor_calendario_filtro');
    if (profFiltroEl) {
        profFiltroEl.addEventListener('change', () => calendar.refetchEvents());
    }

    // MODAL DE AGENDAMENTO E FORMSETS
    const modalEl = document.getElementById('agendamentoModal');
    if (modalEl) {
        const form = modalEl.querySelector('form');
        const errorDiv = modalEl.querySelector('#modal-errors');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        if (form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const formData = new FormData(form);

                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modal.hide();
                        calendar.refetchEvents();
                    } else if (data.errors && errorDiv) {
                        errorDiv.innerHTML = data.errors.map(err => `
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                              ${err}
                              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        `).join('');
                    }
                })
                .catch(err => {
                    if (errorDiv) {
                        errorDiv.innerHTML = `<div class="alert alert-danger">Erro ao enviar o formulário.</div>`;
                    }
                    console.error("Erro AJAX:", err);
                });
            });

            // ----- FORMSETS -----
            function setupFormset(buttonId, containerId, totalFormsId, emptyFormId, prefix) {
                const addButton = document.getElementById(buttonId);
                const container = document.getElementById(containerId);
                const totalForms = document.getElementById(totalFormsId);
                const emptyFormTemplate = document.getElementById(emptyFormId);

                if (!addButton || !container || !totalForms || !emptyFormTemplate) return;

                addButton.addEventListener('click', function (e) {
                    e.preventDefault();
                    const formIndex = parseInt(totalForms.value);
                    const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formIndex);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = newFormHtml;
                    container.appendChild(tempDiv.firstElementChild);
                    totalForms.value = formIndex + 1;
                });
            }

            function toggleFormsets() {
                const checkRecorrente = document.getElementById('id_recorrente_mensal');
                const avisoRecorrente = document.getElementById('aviso-recorrente');
                if (checkRecorrente && avisoRecorrente) {
                    checkRecorrente.addEventListener('change', function () {
                        avisoRecorrente.classList.toggle('d-none', !this.checked);
                    });
                }
            }

            setupFormset('add-aluno-form', 'aluno-formset-container', 'id_alunos-TOTAL_FORMS', 'empty-form-alunos', 'alunos');
            setupFormset('add-professor-form', 'professor-formset-container', 'id_professores-TOTAL_FORMS', 'empty-form-professores', 'professores');
            toggleFormsets();
        }
    }
});
</script>
{% endblock %}
