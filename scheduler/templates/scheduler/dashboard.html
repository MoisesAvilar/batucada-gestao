{% extends "scheduler/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>{{ titulo }}</h1>
  {% if user.tipo == 'admin' %}
  <span class="badge bg-primary fs-6">Vis√£o do Administrador</span>
  {% else %}
  <span class="badge bg-success fs-6">Vis√£o do Professor</span>
  {% endif %}
</div>

{% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>{% endfor %}{% endif %}

{# --- VIS√ÉO DO ADMINISTRADOR --- #}
{% if user.tipo == 'admin' %}
    <div class="row mb-4">
        <div class="col-md-4"><div class="card text-center text-bg-info"><div class="card-body"><h5 class="card-title">Aulas Hoje</h5><p class="card-text fs-4 fw-bold">{{ aulas_hoje_count }}</p></div></div></div>
        <div class="col-md-4"><div class="card text-center text-bg-primary"><div class="card-body"><h5 class="card-title">Aulas na Semana</h5><p class="card-text fs-4 fw-bold">{{ aulas_semana_count }}</p></div></div></div>
        <div class="col-md-4"><div class="card text-center text-bg-secondary"><div class="card-body"><h5 class="card-title">Total de Aulas Agendadas</h5><p class="card-text fs-4 fw-bold">{{ aulas_agendadas_total }}</p></div></div></div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Vis√£o Geral da Agenda</h5>
            <div class="ms-auto">
                <select id="professor_calendario_filtro" class="form-select form-select-sm">
                    <option value="">Todos os Professores</option>
                    {% for prof in professores_list %}<option value="{{ prof.id }}">{{ prof.username|title }}</option>{% endfor %}
                </select>
            </div>
        </div>
        <div class="card-body"><div id='fullcalendar'></div></div>
    </div>
    
    <h4 class="mt-5">Aulas de Hoje ({{ today|date:"d/m/Y" }})</h4>
    <div class="card shadow-sm">
      <div class="card-body">
        {% include 'scheduler/partials/aula_table.html' with aulas=aulas_do_dia %}
      </div>
    </div>

{# --- VIS√ÉO DO PROFESSOR --- #}
{% else %}
    <div class="row mb-4">
        <div class="col-md-4"><div class="card text-center text-bg-info"><div class="card-body"><h5 class="card-title">Minhas Aulas Hoje</h5><p class="card-text fs-4 fw-bold">{{ aulas_hoje_count }}</p></div></div></div>
        <div class="col-md-4"><div class="card text-center text-bg-primary"><div class="card-body"><h5 class="card-title">Minhas Aulas na Semana</h5><p class="card-text fs-4 fw-bold">{{ aulas_semana_count }}</p></div></div></div>
        <div class="col-md-4"><div class="card text-center text-bg-danger"><div class="card-body"><h5 class="card-title">Aulas Pendentes de Valida√ß√£o</h5><p class="card-text fs-4 fw-bold">{{ aulas_pendentes_count }}</p></div></div></div>
    </div>

    {% if aulas_pendentes_validacao %}
    <div class="card shadow-sm mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5><i class="bi bi-exclamation-triangle-fill"></i> A√ß√£o Necess√°ria: Aulas Pendentes de Valida√ß√£o</h5>
        </div>
        <div class="card-body">
            <p class="text-muted small">As aulas abaixo j√° ocorreram mas ainda n√£o tiveram o relat√≥rio preenchido.</p>
            {% include 'scheduler/partials/aula_table.html' with aulas=aulas_pendentes_validacao %}
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5>Minha Agenda</h5></div>
        <div class="card-body"><div id='fullcalendar'></div></div>
    </div>
    
    {# --- BLOCO CORRIGIDO/ADICIONADO --- #}
    {# Adicionamos a lista de aulas de hoje tamb√©m para o professor #}
    <h4 class="mt-5">Minhas Aulas de Hoje ({{ today|date:"d/m/Y" }})</h4>
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        {% include 'scheduler/partials/aula_table.html' with aulas=aulas_do_dia %}
      </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  function toTitleCase(str) {
        if (!str) return '';
        return str.toLowerCase().split(' ').map(function(word) {
            return word.charAt(0).toUpperCase() + word.slice(1);
        }).join(' ');
    }
    const statusColorMap = {
        'Realizada': 'success',
        'Agendada': 'info',
        'Cancelada': 'danger',
        'Aluno Ausente': 'warning'
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('fullcalendar');
        if (calendarEl) {
            // L√≥gica de responsividade (igual √† anterior)
            var initialView = window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth';
            
            // Configura√ß√£o do Calend√°rio
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: initialView,
                locale: 'pt-br',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                height: 'auto',
                buttonText: {
                    today:    'Hoje',
                    month:    'M√™s',
                    week:     'Semana',
                    day:      'Dia',
                    listWeek: 'Lista' // O nome da view de lista √© 'listWeek'
                },
                noEventsContent: "üì≠ Nenhuma aula encontrada para este per√≠odo.",
                allDayText: 'Dia Inteiro',
                eventMouseEnter: function(info) {
                  // --- CORRE√á√ÉO AQUI: USANDO O MAPA DE CORES ---
                  const status = info.event.extendedProps.status;
                  const badgeClass = statusColorMap[status] || 'secondary'; // Usa 'secondary' como cor padr√£o
                  const textColorClass = (badgeClass === 'warning' || badgeClass === 'info') ? 'text-dark' : '';
                  
                  var popover = new bootstrap.Popover(info.el, {
                    title: info.event.extendedProps.modalidade.charAt(0).toUpperCase() + info.event.extendedProps.modalidade.slice(1),
                    content: `
                      <strong>Aluno:</strong> ${toTitleCase(info.event.extendedProps.aluno)}<br>
                      <strong>Status:</strong> <span class="badge ${textColorClass} bg-${badgeClass}">${status}</span><br>
                      <strong>Prof. Atribu√≠do:</strong> ${toTitleCase(info.event.extendedProps.professor_atribuido)}
                    `,
                    placement: 'top',
                    html: true,
                    container: 'body',
                  });
                  
                  info.el.bsPopover = popover;
                  popover.show();
                },

                eventMouseLeave: function(info) {
                  if (info.el.bsPopover) {
                    info.el.bsPopover.dispose();
                    info.el.bsPopover = null;
                  }
                },

                eventSources: [{
                    url: "{% url 'scheduler:get_eventos_calendario' %}",
                    extraParams: function() {
                        // Para o admin, pega o valor do filtro. Para professor, n√£o envia nada (a view se encarrega).
                        var profFiltro = document.getElementById('professor_calendario_filtro');
                        return { professor_filtro_id: profFiltro ? profFiltro.value : "" };
                    },
                    failure: function() { alert('Houve um erro ao carregar os eventos!'); },
                }],
                eventClick: function(info) { if (info.event.url) { info.jsEvent.preventDefault(); window.location.href = info.event.url; } },
                // A√ß√£o de clique na data s√≥ funciona para o admin
                dateClick: function(info) {
                    if ({% if user.tipo == 'admin' %}true{% else %}false{% endif %}) {
                        window.location.href = "{% url 'scheduler:aula_agendar' %}?data_hora=" + info.dateStr + "T08:00";
                    }
                }
            });
            calendar.render();

            // Adiciona listener para o filtro de professor do admin
            var profFiltroEl = document.getElementById('professor_calendario_filtro');
            if (profFiltroEl) {
                profFiltroEl.addEventListener('change', function() {
                    calendar.refetchEvents(); // Recarrega os eventos do calend√°rio
                });
            }
        }
    });
</script>
{% endblock %}