{% extends "scheduler/base.html" %}

{% block content %}
{# --- CABEÇALHO --- #}
<div class="text-center mb-4">
    <h1 class="mb-1">{{ titulo }}</h1>
    {% if user.tipo == 'admin' %}
        <p class="text-muted mb-0">Visão geral do sistema e atalhos rápidos.</p>
    {% else %}
        <p class="text-muted mb-0">Resumo das suas atividades e agenda.</p>
    {% endif %}
</div>
{% if user.tipo == 'admin' %}
<div class="d-flex justify-content-center justify-content-md-end align-items-center gap-2 mb-4">
    <a href="{% url 'scheduler:relatorios_aulas' %}" class="btn btn-secondary"><i class="bi bi-bar-chart-line-fill me-1"></i> Relatórios</a>
    <a href="{% url 'scheduler:aula_agendar' %}" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i> Agendar Aula</a>
</div>
{% endif %}

{# --- VISÃO DO ADMINISTRADOR --- #}
{% if user.tipo == 'admin' %}
    {# Cards de Resumo #}
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-info shadow h-100"><div class="card-body"><div class="row g-0 align-items-center"><div class="col"><div class="small fw-bold text-uppercase mb-1">Aulas Hoje</div><div class="h3 mb-0 fw-bold">{{ aulas_hoje_count }}</div></div><div class="col-auto"><i class="bi bi-calendar-day fs-1 opacity-75"></i></div></div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-primary shadow h-100"><div class="card-body"><div class="row g-0 align-items-center"><div class="col"><div class="small fw-bold text-uppercase mb-1">Aulas na Semana</div><div class="h3 mb-0 fw-bold">{{ aulas_semana_count }}</div></div><div class="col-auto"><i class="bi bi-calendar-week fs-1 opacity-75"></i></div></div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><div class="card text-bg-secondary shadow h-100"><div class="card-body"><div class="row g-0 align-items-center"><div class="col"><div class="small fw-bold text-uppercase mb-1">Total Agendadas</div><div class="h3 mb-0 fw-bold">{{ aulas_agendadas_total }}</div></div><div class="col-auto"><i class="bi bi-clock-history fs-1 opacity-75"></i></div></div></div></div></div>
        <div class="col-xl-3 col-md-6 mb-4"><a href="{% url 'scheduler:aluno_listar' %}?data_inicial={{ primeiro_dia_mes }}&data_final={{ ultimo_dia_mes }}" class="text-decoration-none"><div class="card text-bg-success shadow h-100 card-hover"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col me-2"><div class="text-xs fw-bold text-uppercase mb-1">Novos Alunos (Este Mês)</div><div class="h5 mb-0 fw-bold">{{ novos_alunos_mes }}</div></div><div class="col-auto"><i class="bi bi-person-plus-fill fs-2 text-white-50"></i></div></div></div></div></a></div>
    </div>
    
    {# Calendário do Admin #}
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>Visão Geral da Agenda</h5>
            <div class="ms-auto"><select id="professor_calendario_filtro" class="form-select form-select-sm"><option value="">Todos os Professores</option>{% for prof in professores_list %}<option value="{{ prof.id }}">{{ prof.username|title }}</option>{% endfor %}</select></div>
        </div>
        <div class="card-body"><div id='fullcalendar'></div></div>
    </div>
    
    {# Seção de Aulas de Hoje para o Admin #}
    {# --- SEÇÃO "AULAS DE HOJE" CORRIGIDA PARA ADMIN --- #}
<div class="card shadow-sm mt-4">
    <div class="card-header text-center py-3">
        <h5 class="mb-0">
            Aulas de Hoje
            <span class="badge bg-primary rounded-pill align-middle ms-1">{{ aulas_hoje_count }}</span>
        </h5>
        <small class="text-muted">
            {{ today|date:"l, d \d\e F"|capfirst }}
        </small>
    </div>
    <div class="card-body p-0">
        {% if aulas_do_dia %}
            {% include 'scheduler/partials/aula_table.html' with aulas=aulas_do_dia %}
        {% else %}
            <div class="text-center text-muted p-4">Nenhuma aula agendada para hoje no sistema.</div>
        {% endif %}
    </div>
</div>

{# --- VISÃO DO PROFESSOR --- #}
{% else %}
    {# Cards de Resumo do Professor #}
    <div class="row">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card text-bg-info shadow h-100">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col">
                            {# --- CORRIGIDO AQUI --- #}
                            <div class="small fw-bold text-uppercase mb-1">Minhas Aulas Hoje</div>
                            <div class="h3 mb-0 fw-bold">{{ aulas_hoje_count }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-calendar-day fs-1 opacity-75"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card text-bg-primary shadow h-100">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col">
                            <div class="small fw-bold text-uppercase mb-1">Minhas Aulas na Semana</div>
                            <div class="h3 mb-0 fw-bold">{{ aulas_semana_count }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-calendar-week fs-1 opacity-75"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card text-bg-danger shadow h-100">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col">
                            <div class="small fw-bold text-uppercase mb-1">Pendentes de Validação</div>
                            <div class="h3 mb-0 fw-bold">{{ aulas_pendentes_count }}</div>
                        </div>
                        <div class="col-auto"><i class="bi bi-exclamation-triangle-fill fs-1 opacity-75"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Aulas Pendentes de Validação #}
    {% if aulas_pendentes_validacao %}
    <div class="card shadow-sm mb-4 border-danger">
        <div class="card-header bg-danger text-white"><h5><i class="bi bi-exclamation-triangle-fill"></i> Ação Necessária: Aulas Pendentes de Validação</h5></div>
        <div class="card-body">
            <p class="text-muted small">As aulas abaixo já ocorreram mas ainda não tiveram o relatório preenchido.</p>
            {% include 'scheduler/partials/aula_table.html' with aulas=aulas_pendentes_validacao %}
        </div>
    </div>
    {% endif %}

    {# Calendário do Professor #}
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5>Minha Agenda</h5></div>
        <div class="card-body"><div id='fullcalendar'></div></div>
    </div>
    
    {# Seção de Aulas de Hoje para o Professor #}
     <div class="card shadow-sm mb-4">
        <div class="card-header text-center py-3">
            <h5 class="mb-0">
                Minhas Aulas de Hoje
                <span class="badge bg-primary rounded-pill align-middle ms-1">{{ aulas_hoje_count }}</span>
            </h5>
            <small class="text-muted">
                {{ today|date:"l, d \d\e F"|capfirst }}
            </small>
        </div>
        <div class="card-body p-0">
            {% if aulas_do_dia %}
                {% include 'scheduler/partials/aula_table.html' with aulas=aulas_do_dia %}
            {% else %}
                <div class="text-center text-muted p-4">Você não tem aulas agendadas para hoje.</div>
            {% endif %}
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  function toTitleCase(str) {
        if (!str) return '';
        return str.toLowerCase().split(' ').map(function(word) {
            return word.charAt(0).toUpperCase() + word.slice(1);
        }).join(' ');
    }
    const statusColorMap = {
        'Realizada': 'success',
        'Agendada': 'info',
        'Cancelada': 'danger',
        'Aluno Ausente': 'warning'
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('fullcalendar');
        if (calendarEl) {
            // 1. Define se a tela é mobile
            const isMobile = window.innerWidth < 768;
            
            // 2. Define as configurações do cabeçalho com base no tamanho da tela
            const mobileHeaderToolbar = {
                left: 'title',                                  // Título da data à esquerda
                center: '',                                     // Centro vazio
                right: 'listWeek,dayGridMonth prev,next'        // Botões de visão e navegação agrupados à direita
            };
            const desktopHeaderToolbar = {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,listWeek'
            };

            // Configuração do Calendário com a nova lógica
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'listWeek' : 'dayGridMonth',
                headerToolbar: isMobile ? mobileHeaderToolbar : desktopHeaderToolbar,
                 views: {
                    dayGridMonth: { // Visão de Mês
                        titleFormat: { year: 'numeric', month: 'long' } // Ex: "Julho de 2025"
                    },
                    timeGridWeek: { // Visão de Semana
                        titleFormat: { day: 'numeric', month: 'short' } // Ex: "6 - 12 de jul"
                    },
                    listWeek: { // Visão de Lista
                        titleFormat: { day: 'numeric', month: 'short' } // Ex: "6 - 12 de jul"
                    }
                },
                locale: 'pt-br',
                height: 'auto',
                buttonText: { today: 'Hoje', month: 'Mês', week: 'Semana', day: 'Dia', listWeek: 'Lista' },
                noEventsContent: "📭 Nenhuma aula encontrada para este período.",
                allDayText: 'Dia Inteiro',
                eventMouseEnter: function(info) {
                  // --- CORREÇÃO AQUI: USANDO O MAPA DE CORES ---
                  const status = info.event.extendedProps.status;
                  const badgeClass = statusColorMap[status] || 'secondary'; // Usa 'secondary' como cor padrão
                  const textColorClass = (badgeClass === 'warning' || badgeClass === 'info') ? 'text-dark' : '';
                  
                  var popover = new bootstrap.Popover(info.el, {
                    title: info.event.extendedProps.modalidade.charAt(0).toUpperCase() + info.event.extendedProps.modalidade.slice(1),
                    content: `
                      <strong>Aluno:</strong> ${toTitleCase(info.event.extendedProps.aluno)}<br>
                      <strong>Status:</strong> <span class="badge ${textColorClass} bg-${badgeClass}">${status}</span><br>
                      <strong>Prof. Atribuído:</strong> ${toTitleCase(info.event.extendedProps.professor_atribuido)}
                    `,
                    placement: 'top',
                    html: true,
                    container: 'body',
                  });
                  
                  info.el.bsPopover = popover;
                  popover.show();
                },

                eventMouseLeave: function(info) {
                  if (info.el.bsPopover) {
                    info.el.bsPopover.dispose();
                    info.el.bsPopover = null;
                  }
                },

                eventSources: [{
                    url: "{% url 'scheduler:get_eventos_calendario' %}",
                    extraParams: function() {
                        // Para o admin, pega o valor do filtro. Para professor, não envia nada (a view se encarrega).
                        var profFiltro = document.getElementById('professor_calendario_filtro');
                        return { professor_filtro_id: profFiltro ? profFiltro.value : "" };
                    },
                    failure: function() { alert('Houve um erro ao carregar os eventos!'); },
                }],
                eventClick: function(info) { if (info.event.url) { info.jsEvent.preventDefault(); window.location.href = info.event.url; } },
                // Ação de clique na data só funciona para o admin
                dateClick: function(info) {
                    if ({% if user.tipo == 'admin' %}true{% else %}false{% endif %}) {
                        window.location.href = "{% url 'scheduler:aula_agendar' %}?data_hora=" + info.dateStr + "T08:00";
                    }
                }
            });
            calendar.render();

            // Adiciona listener para o filtro de professor do admin
            var profFiltroEl = document.getElementById('professor_calendario_filtro');
            if (profFiltroEl) {
                profFiltroEl.addEventListener('change', function() {
                    calendar.refetchEvents(); // Recarrega os eventos do calendário
                });
            }
        }
    });
</script>
{% endblock %}