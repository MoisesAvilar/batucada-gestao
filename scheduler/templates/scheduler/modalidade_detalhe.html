{% extends "scheduler/base.html" %}

{% block content %}
<style>
    .content-block {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        border-radius: 0.75rem;
        padding: 1.5rem;
    }
    .kpi-card {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        border-radius: 0.75rem;
        padding: 1.25rem;
        text-align: center;
    }
    .kpi-card .kpi-icon { font-size: 1.75rem; }
    .kpi-card .kpi-value { font-size: 2rem; font-weight: 700; }
    .kpi-card .kpi-label { font-size: 0.8rem; text-transform: uppercase; color: var(--bs-secondary-color); }
    
    .initials-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--bs-primary-bg-subtle);
        color: var(--bs-emphasis-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .list-group-item {
        background-color: transparent;
        padding-left: 0;
        padding-right: 0;
        border-color: var(--bs-border-color-translucent);
    }
    
    @media (min-width: 992px) {
        .sticky-lg-top {
            position: sticky;
            top: 1.5rem;
            z-index: 1010;
        }
    }
</style>

<div class="row g-4">
    {# --- COLUNA PRINCIPAL (ESQUERDA) --- #}
    <div class="col-lg-8">
        <div class="vstack gap-4">
            
            {# --- KPIs --- #}
            <div class="row g-3">
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="kpi-icon text-secondary-emphasis"><i class="bi bi-stack"></i></div>
                        <div class="kpi-value mt-2">{{ total_aulas }}</div>
                        <div class="kpi-label mt-1">Total</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="kpi-icon text-success-emphasis"><i class="bi bi-calendar2-check"></i></div>
                        <div class="kpi-value mt-2">{{ total_realizadas }}</div>
                        <div class="kpi-label mt-1">Realizadas</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="kpi-icon text-info-emphasis"><i class="bi bi-people-fill"></i></div>
                        <div class="kpi-value mt-2">{{ alunos_ativos_count }}</div>
                        <div class="kpi-label mt-1">Alunos</div>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="kpi-card h-100">
                        <div class="kpi-icon text-primary-emphasis"><i class="bi bi-person-video3"></i></div>
                        <div class="kpi-value mt-2">{{ professores_count }}</div>
                        <div class="kpi-label mt-1">Professores</div>
                    </div>
                </div>
            </div>

            {# --- GRÁFICO --- #}
            <div class="content-block">
                <h5 class="mb-3">Atividade Mensal da Categoria</h5>
                {% if chart_data %}
                    <div style="height: 350px;"><canvas id="activityChart"></canvas></div>
                {% else %}
                    <div class="text-center text-muted p-5">Nenhum dado de atividade encontrado para exibir.</div>
                {% endif %}
            </div>

            {# --- TABELA DE AULAS --- #}
            <h3 class="mt-5 mb-3">Histórico de Aulas Recentes</h3>
            {# --- NOVA DIV CONTAINER --- #}
            {# Envolvemos a tabela e a paginação em um container com um ID #}
            <div id="tabela-aulas-container">
                <div class="card shadow-sm">
                <div class="card-body">
                    {% include 'scheduler/partials/aula_table.html' with aulas=aulas %}
                </div>
                </div>
                {# Paginação #}
                <div class="mt-4">
                    {% include 'scheduler/partials/pagination.html' with page_obj=aulas %}
                </div>
            </div>
        </div>
    </div>

    {# --- COLUNA LATERAL (DIREITA) --- #}
    <div class="col-lg-4">
        <div class="sticky-lg-top">
            <div class="vstack gap-4">
                <div class="content-block">
                    <h2 class="h3 mb-1">{{ titulo|title }}</h2>
                    <p class="text-muted">Estatísticas de uso e professores que lecionam esta categoria.</p>

                    {% if user.tipo == 'admin' %}
                    <div class="d-grid gap-2 mt-4">
                        <a href="{% url 'scheduler:modalidade_editar' modalidade.pk %}" class="btn btn-primary"><i class="bi bi-pencil-square me-1"></i> Editar Categoria</a>
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{% url 'scheduler:modalidade_excluir' modalidade.pk %}"><i class="bi bi-trash me-1"></i> Excluir</button>
                    </div>
                    {% endif %}
                </div>

                <div class="content-block">
                    <h6 class="mb-3">Professores Associados</h6>
                    <ul class="list-group list-group-flush">
                        {% for professor in professores_da_modalidade %}
                        <li class="list-group-item">
                            <a href="{% url 'scheduler:professor_detalhe' professor.pk %}" class="text-decoration-none text-body d-flex align-items-center gap-3">
                                <div class="initials-avatar">{{ professor.username|first|upper }}</div>
                                <span class="fw-bold">{{ professor.username|title }}</span>
                            </a>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-muted small">Nenhum professor leciona esta categoria.</li>
                        {% endfor %}
                    </ul>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
{{ block.super }}
{{ chart_labels|json_script:"chart-labels-data" }}
{{ chart_data|json_script:"chart-data-data" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    let activityChartInstance = null;

    function getChartThemeColors() {
        const rootStyles = getComputedStyle(document.documentElement);
        return {
            fontColor: rootStyles.getPropertyValue('--bs-body-color').trim(),
            gridColor: rootStyles.getPropertyValue('--bs-border-color-translucent').trim(),
            lineColor: rootStyles.getPropertyValue('--bs-primary').trim(),
            fillColor: `rgba(${rootStyles.getPropertyValue('--bs-primary-rgb').trim()}, 0.1)`
        };
    }

    function renderOrUpdateChart() {
        if (activityChartInstance) {
            activityChartInstance.destroy();
        }

        const themeColors = getChartThemeColors();
        Chart.defaults.color = themeColors.fontColor;
        Chart.defaults.borderColor = themeColors.gridColor;

        const labels = JSON.parse(document.getElementById('chart-labels-data')?.textContent || '[]');
        const data = JSON.parse(document.getElementById('chart-data-data')?.textContent || '[]');
        const ctx = document.getElementById('activityChart');
        
        if (ctx && data.length > 0) {
            activityChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Aulas',
                        data: data,
                        fill: true,
                        borderColor: themeColors.lineColor,
                        backgroundColor: themeColors.fillColor,
                        tension: 0.3,
                        pointBackgroundColor: themeColors.lineColor,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }
    }

    renderOrUpdateChart();

    const themeObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
                renderOrUpdateChart();
            }
        }
    });

    themeObserver.observe(document.documentElement, { attributes: true });
});
</script>
{% endblock %}