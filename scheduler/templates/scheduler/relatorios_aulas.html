{% extends "scheduler/base.html" %}

{% block content %}

{# ★★★ CSS APRIMORADO COM VARIÁVEIS PARA LIGHT/DARK MODE ★★★ #}
<style>
    .dropdown-menu {
        z-index: 1100 !important;
    }
    body {
        background-color: var(--bs-body-bg);
    }
    .initials-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--bs-primary-bg-subtle);
        color: var(--bs-emphasis-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .chart-container, .table-container {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        padding: 1.5rem;
        border-radius: 0.75rem;
    }
    .kpi-card-wrapper {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        padding: 1.5rem;
        border-radius: 0.75rem;
    }
    .kpi-card .h1 { font-weight: 700; }
    @media (min-width: 992px) {
        .sticky-lg-top {
            position: sticky;
            top: 1.5rem;
            z-index: 1010;
        }
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Relatórios de Aulas</h1>
        <p class="text-muted mb-0 d-none d-md-block">Análise de desempenho e estatísticas gerais.</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">
            <i class="bi bi-funnel me-1"></i> Filtros
        </button>
        <div class="dropdown">
            <button class="btn btn-outline-secondary" type="button" id="exportOptions" data-bs-toggle="dropdown" aria-expanded="false" title="Mais Opções">
                <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportOptions">
                <li><h6 class="dropdown-header">Opções de Exportação</h6></li>
                <li><a class="dropdown-item" href="{% url 'scheduler:exportar_aulas' %}?{{ request.GET.urlencode }}"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Detalhes</a></li>
                <li><a class="dropdown-item" href="{% url 'scheduler:exportar_relatorio_agregado' %}?{{ request.GET.urlencode }}"><i class="bi bi-file-earmark-bar-graph me-2"></i>Exportar Resumo</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title" id="filtersOffcanvasLabel"><i class="bi bi-funnel-fill me-2"></i>Filtros Avançados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
        <form method="GET" action="{% url 'scheduler:relatorios_aulas' %}" id="filter-form" class="flex-grow-1">
            <div class="d-flex flex-wrap gap-2 mb-4">
                <button type="button" class="btn btn-sm btn-outline-primary flex-fill" id="filter-today">Hoje</button>
                <button type="button" class="btn btn-sm btn-outline-primary flex-fill" id="filter-week">Semana</button>
                <button type="button" class="btn btn-sm btn-outline-primary flex-fill" id="filter-month">Mês</button>
            </div>
            
            <div class="mb-3">
                <label for="id_data_inicial" class="form-label small fw-bold">Data Inicial</label>
                <input type="date" id="id_data_inicial" name="data_inicial" class="form-control" value="{{ data_inicial }}">
            </div>
            <div class="mb-3">
                <label for="id_data_final" class="form-label small fw-bold">Data Final</label>
                <input type="date" id="id_data_final" name="data_final" class="form-control" value="{{ data_final }}">
            </div>
            <div class="mb-3">
                <label for="id_professor_filtro" class="form-label small fw-bold">Professor</label>
                <select id="id_professor_filtro" name="professor_filtro" class="form-select">
                    <option value="">Todos</option>
                    {% for prof in professores_list %}<option value="{{ prof.pk }}" {% if prof.pk|stringformat:"d" == professor_filtro %}selected{% endif %}>{{ prof.username|title }}</option>{% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="id_modalidade_filtro" class="form-label small fw-bold">Categoria</label>
                <select id="id_modalidade_filtro" name="modalidade_filtro" class="form-select">
                    <option value="">Todas</option>
                    {% for modalidade in modalidades_list %}<option value="{{ modalidade.id }}" {% if modalidade.id|stringformat:"d" == modalidade_filtro %}selected{% endif %}>{{ modalidade.nome|title }}</option>{% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="id_aluno_filtro" class="form-label small fw-bold">Aluno(s)</label>
                <select id="id_aluno_filtro" name="aluno_filtro" class="form-select" multiple>
                    {% for aluno in alunos_list %}<option value="{{ aluno.pk }}" {% if aluno.pk in aluno_filtro_ids %}selected{% endif %}>{{ aluno.nome_completo|title }}</option>{% endfor %}
                </select>
            </div>
             <div class="mb-3">
                <label for="id_status_filtro" class="form-label small fw-bold">Status</label>
                <select id="id_status_filtro" name="status_filtro" class="form-select">
                    <option value="">Todos</option>
                    {% for status_value, status_label in status_choices %}<option value="{{ status_value }}" {% if status_value == status_filtro %}selected{% endif %}>{{ status_label }}</option>{% endfor %}
                    <option value="Substituído" {% if 'Substituído' == status_filtro %}selected{% endif %}>Substituído</option>
                    <option value="professor_ausente" {% if 'professor_ausente' == status_filtro %}selected{% endif %}>Professor Ausente (em ACs)</option>
                </select>
            </div>
            
            <div class="mt-auto pt-3 border-top">
                 <div class="d-flex gap-2">
                    <a href="{% url 'scheduler:relatorios_aulas' %}" class="btn btn-outline-secondary w-100">Limpar</a>
                    <button class="btn btn-primary w-100" type="submit" name="action" value="filter_report">
                        <i class="bi bi-bar-chart-line me-1"></i> Ver Relatório
                    </button>
                </div>
                <div class="mt-2">
                     <button class="btn btn-outline-info w-100" type="submit" name="action" value="view_list">
                        <i class="bi bi-list-ul me-1"></i> Ver Lista Detalhada
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="vstack gap-4">
            <div class="chart-container">
                <h5 class="mb-0">Evolução de Aulas</h5>
                <p class="text-muted small">Aulas realizadas no período filtrado.</p>
                <div class="mt-3" style="height: 300px;"><canvas id="monthlyTrendChart"></canvas></div>
            </div>

            <div class="table-container">
                <h5 class="mb-3">Desempenho por Professor</h5>
                <div class="table-responsive">
                    <table class="table table-borderless table-hover align-middle mb-0">
                        <thead class="bg-body-secondary text-body">
                            <tr>
                                <th scope="col" class="ps-3">Professor</th>
                                <th scope="col" class="text-center">Realizadas</th>
                                <th scope="col" class="d-none d-sm-table-cell text-center">Atribuídas</th>
                                <th scope="col" class="text-end pe-3">Taxa de Realização</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in aulas_por_professor %}
                            <tr>
                                <td class="ps-3">
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="initials-avatar" title="{{ p.username|title }}">{{ p.username|first|upper }}</div>
                                        <a href="{% url 'scheduler:professor_detalhe' p.pk %}" class="text-decoration-none fw-bold text-body">{{ p.username|title }}</a>
                                    </div>
                                </td>
                                <td class="text-center fw-bold">{{ p.total_realizadas }}</td>
                                <td class="d-none d-sm-table-cell text-center text-muted">{{ p.total_atribuidas }}</td>
                                <td class="text-end pe-3">
                                    <div class="progress" style="height: 6px;" title="{{ p.taxa_realizacao|floatformat:1 }}%">
                                        <div class="progress-bar rounded-pill {% if p.taxa_realizacao >= 80 %}bg-success{% elif p.taxa_realizacao >= 50 %}bg-warning{% else %}bg-danger{% endif %}"
                                             role="progressbar" style="width: {{ p.taxa_realizacao|floatformat:0 }}%;"
                                             aria-valuenow="{{ p.taxa_realizacao|floatformat:0 }}">
                                        </div>
                                    </div>
                                    <span class="ms-2 small text-muted">{{ p.taxa_realizacao|floatformat:1 }}%</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted p-5">Nenhum dado para exibir.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
             <div class="chart-container">
                <h5 class="mb-0">Volume de Aulas por Categoria</h5>
                <p class="text-muted small">Volume de aulas realizadas para cada categoria ao longo do tempo.</p>
                 {% if desempenho_modalidades_datasets %}
                    <div class="mt-3" style="height: 350px;"><canvas id="modalityPerformanceChart"></canvas></div>
                {% else %}
                    <div class="text-center text-muted p-5">Nenhum dado de aula realizada encontrado para exibir.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="sticky-lg-top">
            <div class="vstack gap-4">
                <div class="kpi-card-wrapper">
                     <div class="kpi-card text-center">
                        <h6 class="text-muted text-uppercase small">Total de Aulas</h6>
                        <div class="h1 text-primary">{{ total_aulas }}</div>
                    </div>
                    <hr>
                    <div class="row g-3 text-center">
                        <div class="col-6">
                            <h6 class="text-muted text-uppercase small">Realizadas</h6>
                            <div class="h3 fw-bold text-success">{{ total_realizadas }}</div>
                        </div>
                         <div class="col-6">
                            <h6 class="text-muted text-uppercase small">Taxa de Sucesso</h6>
                            <div class="h3 fw-bold text-info">{{ taxa_sucesso }}%</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h5 class="mb-0">Divisão por Categoria</h5>
                    <p class="text-muted small">Distribuição do total de aulas.</p>
                    <div class="mt-3" style="height: 300px;"><canvas id="categoryDoughnutChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
{{ mes_chart_labels|json_script:"mes-chart-labels-data" }}
{{ mes_chart_data|json_script:"mes-chart-data-data" }}
{{ cat_chart_labels|json_script:"cat-chart-labels-data" }}
{{ cat_chart_data|json_script:"cat-chart-data-data" }}
{{ desempenho_modalidades_labels|json_script:"desempenho-labels-data" }}
{{ desempenho_modalidades_datasets|json_script:"desempenho-datasets-data" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
    let charts = {};

    function getChartThemeColors() {
        const rootStyles = getComputedStyle(document.documentElement);
        const theme = document.documentElement.getAttribute('data-bs-theme') || 'light';
        return {
            isDark: theme === 'dark',
            fontColor: rootStyles.getPropertyValue('--bs-body-color').trim(),
            gridColor: rootStyles.getPropertyValue('--bs-border-color-translucent').trim()
        };
    }

    function destroyCharts() {
        Object.values(charts).forEach(chart => chart?.destroy());
        charts = {};
    }

    function createCharts() {
        const themeColors = getChartThemeColors();
        Chart.defaults.color = themeColors.fontColor;
        Chart.defaults.borderColor = themeColors.gridColor;

        const mesLabels = JSON.parse(document.getElementById('mes-chart-labels-data').textContent);
        const mesData = JSON.parse(document.getElementById('mes-chart-data-data').textContent);
        const catLabels = JSON.parse(document.getElementById('cat-chart-labels-data').textContent);
        const catData = JSON.parse(document.getElementById('cat-chart-data-data').textContent);
        const desempenhoLabels = JSON.parse(document.getElementById('desempenho-labels-data').textContent);
        const desempenhoDatasets = JSON.parse(document.getElementById('desempenho-datasets-data').textContent);

        const lineCtx = document.getElementById('monthlyTrendChart');
        if (lineCtx && mesLabels.length > 0) {
            charts.line = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: mesLabels,
                    datasets: [{
                        label: "Aulas Realizadas",
                        data: mesData,
                        fill: true,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        const doughnutCtx = document.getElementById('categoryDoughnutChart');
        if (doughnutCtx && catLabels.length > 0) {
            charts.doughnut = new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catData,
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                color: themeColors.fontColor
                            }
                        }
                    }
                }
            });
        }

        const performanceCtx = document.getElementById('modalityPerformanceChart');
        if (performanceCtx && desempenhoDatasets.length > 0) {
            charts.performance = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: desempenhoLabels,
                    datasets: desempenhoDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: { mode: 'index', intersect: false },
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                color: themeColors.fontColor
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: { color: themeColors.fontColor },
                            grid: { color: themeColors.gridColor }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { color: themeColors.fontColor },
                            grid: { color: themeColors.gridColor }
                        }
                    }
                }
            });
        }
    }

    const observer = new MutationObserver(() => {
        destroyCharts();
        createCharts();
    });

    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['data-bs-theme']
    });

    createCharts();
});
</script>
{% endblock %}
