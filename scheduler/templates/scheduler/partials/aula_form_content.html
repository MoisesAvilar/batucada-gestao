{# ★★★ INÍCIO DO ESTILO AUTOSSUFICIENTE PARA O FORMULÁRIO ★★★ #}
<style>
    /* Estilos Gerais (Modo Claro) */
    .content-block {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        padding: 1.5rem;
        border-radius: 0.75rem;
    }
    .formset-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
    }
    .formset-row .form-field {
        flex-grow: 1;
    }
    .formset-row:nth-child(even) {
        background-color: var(--bs-secondary-bg);
    }

    /* Regras para o Dark Mode */
    [data-bs-theme="dark"] .formset-row:nth-child(even) {
        background-color: var(--bs-gray-800);
    }
    [data-bs-theme="dark"] .select2-container--bootstrap-5 .select2-selection {
        background-color: var(--bs-body-bg);
        border-color: var(--bs-border-color);
    }
    [data-bs-theme="dark"] .select2-container--bootstrap-5 .select2-dropdown {
        background-color: var(--bs-body-bg);
        border-color: var(--bs-border-color-translucent);
    }
    [data-bs-theme="dark"] .select2-results__option {
        color: var(--bs-body-color);
    }
    [data-bs-theme="dark"] .select2-results__option--highlighted {
        background-color: var(--bs-primary);
        color: white;
    }
    [data-bs-theme="dark"] .select2-container--bootstrap-5 .select2-selection__rendered {
        color: var(--bs-body-color);
    }
</style>
{# ★★★ FIM DO ESTILO AUTOSSUFICIENTE ★★★ #}


{# ★★★ INÍCIO DA ESTRUTURA HTML ATUALIZADA ★★★ #}
<form method="post" action="{{ form_action }}" class="vstack gap-4" id="aula-form-modal">
    {% csrf_token %}
    
    <div id="modal-errors" class="alert alert-danger" style="display: none;"></div>

    <div class="content-block">
        <h6 class="mb-3 fw-bold">Detalhes da Aula</h6>
        <div class="row g-3">
            <div class="col-md-4">
                <label for="{{ form.modalidade.id_for_label }}" class="form-label small">Categoria</label>
                {{ form.modalidade }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.data_hora.id_for_label }}" class="form-label small">Data e Horário</label>
                {{ form.data_hora }}
            </div>
            <div class="col-md-4">
                <label for="{{ form.status.id_for_label }}" class="form-label small">Status</label>
                {{ form.status }}
            </div>
        </div>
        <div class="mt-4 form-check form-switch">
            {{ form.recorrente_mensal }}
            <label class="form-check-label" for="{{ form.recorrente_mensal.id_for_label }}">
                {{ form.recorrente_mensal.label }}
            </label>
        </div>
    </div>
    
    <div class="content-block" id="alunos-formset-container-modal">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 fw-bold">Alunos</h6>
            <button type="button" id="add-aluno-form-modal" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i> Adicionar</button>
        </div>
        {{ aluno_formset.management_form }}
        <div id="aluno-forms-modal" class="vstack gap-2">
            {% for form in aluno_formset %}
                <div class="formset-row">
                    <div class="form-field">{{ form.aluno }}</div>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove-row-modal" title="Remover Aluno"><i class="bi bi-trash"></i></button>
                    <div class="d-none">{{ form.DELETE }}{{ form.id }}</div>
                </div>
            {% endfor %}
        </div>
    </div>

    {% if user.tipo == 'admin' %}
    <div class="content-block" id="professores-formset-container-modal">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0 fw-bold">Professores</h6>
            <button type="button" id="add-professor-form-modal" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i> Adicionar</button>
        </div>
        {{ professor_formset.management_form }}
        <div id="professor-forms-modal" class="vstack gap-2">
            {% for form in professor_formset %}
                 <div class="formset-row">
                    <div class="form-field">{{ form.professor }}</div>
                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove-row-modal" title="Remover Professor"><i class="bi bi-trash"></i></button>
                    <div class="d-none">{{ form.DELETE }}{{ form.id }}</div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="mt-3 pt-3 border-top d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal"><i class="bi bi-x-circle me-1"></i> Cancelar</button>
        <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-1"></i> Salvar Aula</button>
    </div>
</form>

<template id="empty-form-alunos-modal">
    <div class="formset-row">
        <div class="form-field">{{ aluno_formset.empty_form.aluno }}</div>
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-row-modal" title="Remover Aluno"><i class="bi bi-trash"></i></button>
        <div class="d-none">{{ aluno_formset.empty_form.DELETE }}{{ aluno_formset.empty_form.id }}</div>
    </div>
</template>
<template id="empty-form-professores-modal">
    <div class="formset-row">
        <div class="form-field">{{ professor_formset.empty_form.professor }}</div>
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-row-modal" title="Remover Professor"><i class="bi bi-trash"></i></button>
        <div class="d-none">{{ professor_formset.empty_form.DELETE }}{{ professor_formset.empty_form.id }}</div>
    </div>
</template>