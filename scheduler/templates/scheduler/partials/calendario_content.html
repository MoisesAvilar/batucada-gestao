<style>
	/*
	==============================================
	ESTILOS MOBILE-FIRST (PADRÃO PARA TODAS AS TELAS)
	==============================================
	*/

	.dropdown-menu {
        z-index: 9999 !important;
    }

	/* Estilos do Calendário Híbrido */
	.agenda-wrapper {
		background-color: var(--bs-secondary-bg);
		border: 1px solid var(--bs-border-color-translucent);
		border-radius: 0.75rem;
		height: 65vh; /* Altura padrão para mobile */
		overflow-y: auto;
		padding: 0.5rem 1rem;
	}

	.agenda-day-header {
        display: flex; /* ★ Alterado para flexbox */
        justify-content: space-between; /* ★ Alinha itens nas extremidades */
        align-items: center; /* ★ Centraliza verticalmente */
        font-weight: 600;
        font-size: 0.9rem; /* Levemente maior */
        color: var(--bs-emphasis-color); /* Cor com mais destaque */
        padding: 0.75rem 1rem; /* Padding mais equilibrado */
        position: sticky;
        top: -9px; /* ★ Corrigido para 0, para grudar no topo da área de rolagem */
        background-color: var(--bs-tertiary-bg);
        z-index: 10;
        border-bottom: 1px solid var(--bs-border-color-translucent);
        border-top: 1px solid var(--bs-border-color-translucent);
        margin-top: 1rem; /* Adiciona espaço entre os dias */
    }
    .agenda-day-header span {
        font-size: .6rem; /* ★ Aumentado para melhor legibilidade */
        color: var(--bs-secondary-color); /* ★ Cor secundária para menos destaque */
    }

    /* ★ Nova Classe: Destaque para o dia de hoje */
    .agenda-day-header.hoje {
        background-color: var(--bs-primary-bg-subtle);
        border-left: 4px solid var(--bs-primary);
        padding-left: calc(1rem - 4px);
        color: var(--bs-primary-text-emphasis);
    }

    /* ★ Nova Classe: Badge para o total de aulas */
    .day-total-badge {
        font-size: 0.75rem;
        font-weight: 600;
        background-color: var(--bs-secondary-bg);
        padding: 0.2rem 0.5rem;
        border-radius: 0.5rem;
        color: var(--bs-secondary-color);
    }

	/* Estilos do Card da Agenda Lateral */
    .agenda-card {
        background-color: var(--bs-secondary-bg);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        padding: 0.75rem 1rem;
        border: 1px solid var(--bs-border-color-translucent);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .agenda-card.realizada {
        background-color: var(--bs-success-bg-subtle);
        color: var(--bs-success-color);
        border-color: var(--bs-success-border-subtle);
    }

    .agenda-card.cancelada {
        background-color: var(--bs-danger-bg-subtle);
        color: var(--bs-danger-color);
        border-color: var(--bs-danger-border-subtle);
    }

    .agenda-card.aluno-ausente {
        background-color: var(--bs-warning-bg-subtle);
        color: var(--bs-warning-color);
        border-color: var(--bs-warning-border-subtle);
    }

    .agenda-card.agendada {
        background-color: var(--bs-info-bg-subtle);
        color: var(--bs-info-color);
        border-color: var(--bs-info-border-subtle);
    }

    .card-header-agenda {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
    }

    /* Título principal do card (Aluno/Atividade) */
    .card-title-agenda {
        font-weight: 600; /* Usando 600 para um negrito menos intenso */
        font-size: 1rem;
        color: var(--bs-emphasis-color); /* Cor de maior destaque */
        margin: 0;
        line-height: 1.3;
    }

    /* Subtítulo (Modalidade) */
    .card-subtitle-agenda {
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
    }


    /* ★★★ NOVO RODAPÉ COM FLEXBOX ★★★ */
    .card-footer-agenda {
        display: flex; /* Ativa o Flexbox */
        justify-content: space-between; /* Alinha os itens nas extremidades */
        align-items: center; /* Centraliza verticalmente */
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
        margin-top: 0.5rem; /* Adiciona um espaço acima do rodapé */
    }

    /* Container para a informação do professor */
    .card-participants {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        /* Impede que o nome do professor quebre a linha e empurre os botões */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .card-title-agenda a {
        color: inherit;
        text-decoration: none;
    }

    .card-title-agenda a:hover {
        text-decoration: underline;
    }


	/* Ações de hover escondidas por padrão (mobile) */
	.agenda-card-actions,
	.popover-actions {
		display: none;
	}

	/* Gatilho de 3 pontos (kebab menu) visível por padrão (mobile) */
	.actions-mobile-trigger {
		display: block;
	}

	/* Estilos do Popover */
	.popover-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.btn-agendar-popover {
		font-size: 0.75rem;
		padding: 0.1rem 0.4rem;
		line-height: 1;
	}

	.popover-aula-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		border-radius: 0.3rem;
		transition: background-color 0.2s ease;
		padding: 0;
	}

	.popover-aula-item:hover {
		background-color: var(--bs-tertiary-bg);
	}

	.popover-event-link {
		padding: 0.35rem 0.5rem;
		flex-grow: 1;
	}

	/*
	==============================================
	AJUSTES PARA DESKTOP (TELAS MAIORES)
	Telas com 992px ou mais de largura
	==============================================
	*/
	@media (min-width: 992px) {
		.agenda-wrapper {
			height: 590px; /* Altura fixa para desktop */
		}

		/* Mostra as ações de hover no desktop */
		.agenda-card-actions,
		.popover-actions {
			display: flex;
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.2s ease-in-out;
		}

		.agenda-card-actions {
			gap: 0.5rem;
		}

		.popover-actions {
			gap: 0.25rem;
			padding-right: 0.5rem;
		}

		/* Animação para mostrar ações no hover */
		.agenda-card:hover .agenda-card-actions,
		.popover-aula-item:hover .popover-actions {
			opacity: 1;
			visibility: visible;
		}

		/* Esconde o gatilho de 3 pontos no desktop */
		.actions-mobile-trigger {
			display: none;
		}
	}
</style>
<div class="calendario-hibrido-wrapper">
    <div class="calendario-header d-lg-flex d-none">
        <button id="cal-prev" class="btn btn-outline-secondary">&lt;</button>
        <h4 id="cal-month-year">{{ mes_atual|date:"F Y"|capfirst }}</h4>
        <button id="cal-next" class="btn btn-outline-secondary">&gt;</button>
    </div>

    <div class="row mt-3 g-lg-4">
        <div class="col-lg-7">
             <div class="calendario-header d-flex d-lg-none mb-3">
                <button id="cal-prev-mobile" class="btn btn-outline-secondary">&lt;</button>
                <h4 id="cal-month-year-mobile">{{ mes_atual|date:"F Y"|capfirst }}</h4>
                <button id="cal-next-mobile" class="btn btn-outline-secondary">&gt;</button>
            </div>
            <div class="mini-grid">
                <div class="calendario-dias-semana-mini">
                    <div>D</div><div>S</div><div>T</div><div>Q</div><div>Q</div><div>S</div><div>S</div>
                </div>
                <div class="calendario-grid-mini">
                    {% for semana in calendario_mes %}
                        {% for dia_info in semana %}
                            {% with dia=dia_info.dia aulas=dia_info.aulas %}
                                <div 
                                    class="dia-celula-mini js-day-cell {% if dia == 0 %}fora-do-mes{% endif %} {% if dia == today.day and mes_atual.month == today.month and mes_atual.year == today.year %}hoje{% endif %}"
                                    {% if dia != 0 %}
                                        data-date="{{ mes_atual|date:'Y-m-' }}{{ dia|stringformat:'02d' }}"
                                        tabindex="0" 
                                        role="button" 
                                        data-bs-toggle="popover" 
                                        data-bs-title="
                                            <div class='d-flex justify-content-between align-items-center'>
                                                <span class='text-muted small'>{{ dia|stringformat:'02d' }} de {{ mes_atual|date:'F'|capfirst }}</span>
                                            </div>
                                            {% if user.tipo in 'admin, professor' %}
                                                <button class='btn btn-sm btn-primary btn-agendar-popover ms-2' 
                                                        data-bs-toggle='modal' 
                                                        data-bs-target='#agendamentoModal'
                                                        data-date-agenda='{{ mes_atual|date:'Y-m-' }}{{ dia|stringformat:'02d' }}'>
                                                    <i class='bi bi-plus'></i> Agendar
                                                </button>
                                            {% endif %}
                                        "
                                    {% endif %}>
                                    
                                    {% if dia != 0 %}
                                        <span class="numero-dia-mini">{{ dia }}</span>
                                        <div class="eventos-dia-mini">
                                            {% if aulas %}
                                            <span class="eventos-contador">{{ aulas|length }}</span>
                                            {% endif %}
                                        </div>

                                        <div class="popover-content d-none">
    {% if aulas %}
        <ul class="list-unstyled mb-0">
            {% for aula in aulas %}
                <li class="popover-aula-item">
                    <a href="{% url 'scheduler:aula_validar' aula.pk %}" class="d-flex align-items-center text-decoration-none text-reset popover-event-link">
                        <span class="hora-badge status-{{ aula.status|slugify }}">{{ aula.data_hora|time:"H:i" }}</span>
                        <span class="ms-2 small">
                            {% if aula.alunos.all|length == 1 %}
                                {{ aula.alunos.first.nome_completo|truncatewords:2 }}
                            {% elif aula.alunos.all|length > 1 %}
                                Grupo: {{ aula.modalidade.nome|title }}
                            {% else %}
                                {{ aula.modalidade.nome|title }}
                            {% endif %}
                        </span>
                    </a>
                    <!-- Desktop: mostra lápis e lixeira -->
                    <div class="popover-actions d-none d-lg-flex">
                        <!-- Editar: disponível para admin e professor -->
                        <a href="{% url 'scheduler:aula_editar' aula.pk %}" class="btn btn-sm bg-body-tertiary border text-body" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </a>

                        <!-- Excluir: apenas admin -->
                        {% if user.tipo == 'admin' %}
                        <button type="button" class="btn btn-sm bg-body-tertiary border text-body" title="Excluir" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{% url 'scheduler:aula_excluir' aula.pk %}">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                    </div>

                    <!-- Mobile: mostra dropdown de 3 pontinhos -->
                    <div class="popover-actions d-flex d-lg-none">
                        <div class="dropdown">
                            <button class="btn btn-sm border-0 py-0 px-1" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Ações">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{% url 'scheduler:aula_editar' aula.pk %}">
                                        <i class="bi bi-pencil-square me-2"></i>Editar
                                    </a>
                                </li>
                                {% if user.tipo == 'admin' %}
                                <li>
                                    <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{% url 'scheduler:aula_excluir' aula.pk %}">
                                        <i class="bi bi-trash me-2"></i>Excluir
                                    </button>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div class="text-muted d-flex flex-column justify-content-center align-items-center py-3">
            <i class="bi bi-calendar-x fs-3 mb-1"></i>
            <small>Sem aulas agendadas</small>
        </div>
    {% endif %}
</div>

                                    {% endif %}
                                </div>
                            {% endwith %}
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="agenda-wrapper">
                {% if not aulas_do_mes_lista %}
                    <div class="d-flex flex-column justify-content-center align-items-center h-100 text-center text-muted p-5">
                        <i class="bi bi-calendar-x fs-1 mb-3"></i>
                        <span>Nenhuma aula encontrada para este mês.</span>
                    </div>
                {% else %}
                    {% regroup aulas_do_mes_lista by data_hora.date as aulas_por_dia %}
                    {% for grupo in aulas_por_dia %}
                        <div class="agenda-day-header {% if grupo.grouper == today %}hoje{% endif %}" id="agenda-{{ grupo.grouper|date:'Y-m-d' }}">
                            
                            {# Lado Esquerdo: Nome do Dia e Badge "Hoje" #}
                            <div class="d-flex align-items-center gap-2">
                                <span>{{ grupo.grouper|date:"l, d \d\e F"|capfirst }}</span>
                                {% if grupo.grouper == today %}
                                    <span class="badge bg-primary">Hoje</span>
                                {% endif %}
                            </div>

                            {# Lado Direito: Contador de Aulas e Botão de Agendar #}
                            <div class="d-flex align-items-center gap-2">
                                <span class="day-total-badge">{{ grupo.list|length }} Aula{{ grupo.list|length|pluralize }}</span>
                                {% if user.tipo in 'admin, professor' %}
                                    <button class="btn btn-sm btn-primary py-0 px-2" 
                                            title="Agendar nova aula para este dia"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#agendamentoModal"
                                            data-date-agenda="{{ grupo.grouper|date:'Y-m-d' }}">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                {% endif %}
                            </div>

                        </div>
                        {% for aula in grupo.list %}
                        <div class="agenda-card {{ aula.status|lower|slugify }}">

                            {# CABEÇALHO: Hora e Status #}
                            <div class="card-header-agenda">
                                <span class="hora-badge">{{ aula.data_hora|date:"H:i" }}</span>
                                <span class="status-badge">{{ aula.get_status_display }}</span>
                            </div>

                            {# CORPO: Título (Aluno/Atividade) e Subtítulo (Modalidade) #}
                            <div>
                                <h6 class="card-title-agenda">
                                    <a href="{% if aula.status == 'Agendada' %}{% url 'scheduler:aula_editar' aula.pk %}{% else %}{% url 'scheduler:aula_validar' aula.pk %}{% endif %}">
                                        {% if "atividade complementar" in aula.modalidade.nome|lower %}
                                            {{ aula.modalidade.nome }}
                                        {% else %}
                                            {{ aula.alunos.all|join:", " }}
                                        {% endif %}
                                    </a>
                                </h6>
                                {% if "atividade complementar" not in aula.modalidade.nome|lower %}
                                    <p class="card-subtitle-agenda mb-0">{{ aula.modalidade.nome }}</p>
                                {% endif %}
                            </div>

                            {# RODAPÉ: Professor(es) atribuído(s) e Ações #}
                            <div class="card-footer-agenda">
                                <div class="card-participants">
                                    <i class="bi bi-person"></i>
                                    <span>Atribuído:</span>
                                    {% for prof in aula.professores.all %}
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">{{ prof.username|slice:":1"|upper }}</span>
                                        <span class="d-none d-sm-inline">{{ prof.username|title }}</span>
                                        {# ★★★ VÍRGULA CORRIGIDA ★★★ #}
                                        {% if not forloop.last %}
                                            <span class="d-none d-sm-inline">, </span>
                                        {% endif %}
                                    {% endfor %}
                                    {% if not aula.professores.all %}
                                        <span class="text-muted small">(N/A)</span>
                                    {% endif %}
                                </div>

                                <div class="card-actions">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light py-0 px-1 border-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Mais Opções">
                                            <i class="bi bi-three-dots-vertical"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item" href="{% if aula.status == 'Agendada' %}{% url 'scheduler:aula_editar' aula.pk %}{% else %}{% url 'scheduler:aula_validar' aula.pk %}{% endif %}"><i class="bi bi-pencil me-2"></i>{% if aula.status == 'Agendada' %}Editar{% else %}Ver Relatório{% endif %}</a></li>
                                            {% if user.tipo == 'admin' %}
                                            <li>
                                                <button type="button" class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{% url 'scheduler:aula_excluir' aula.pk %}">
                                                    <i class="bi bi-trash me-2"></i>Excluir
                                                </button>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                        {% endfor %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>