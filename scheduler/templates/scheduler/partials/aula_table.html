{% if not aulas %}
    <div class="text-center text-muted p-4">Nenhuma aula encontrada.</div>
{% else %}

{# --- 1. VISÃO DE DESKTOP --- #}
<div class="d-none d-lg-block">
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th scope="col">Aluno(s)</th>
                    <th scope="col">Categoria</th>
                    <th scope="col">Prof. Atribuído(s)</th>
                    <th scope="col">Status</th>
                    <th scope="col">Data e Hora</th>
                    <th scope="col" class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for aula in aulas %}
                <tr class="{% if aula.status == 'Cancelada' %}table-secondary{% elif aula.status == 'Aluno Ausente' %}table-light{% endif %}">
                    
                    <td data-label="Aluno(s)">
                        {% if aula.status in "Realizada,Aluno Ausente" and aula.alunos_com_status %}
                            {% for item in aula.alunos_com_status %}
                                <a href="{% url 'scheduler:aluno_detalhe' item.aluno.pk %}" class="text-decoration-none d-inline-block mb-1">
                                    {% if item.status == 'presente' %}
                                        <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle d-inline-flex align-items-center"  data-bs-toggle="tooltip" title="Äluno presente">
                                            <i class="bi bi-person-check-fill me-1"></i>
                                            {{ item.aluno.nome_completo|title }}
                                        </span>
                                    {% elif item.status == 'ausente' %}
                                        <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis border border-warning-subtle d-inline-flex align-items-center"  data-bs-toggle="tooltip" title="Aluno ausente">
                                            <i class="bi bi-person-x-fill me-1"></i>
                                            {{ item.aluno.nome_completo|title }}
                                        </span>
                                    {% else %}
                                        <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle d-inline-flex align-items-center">
                                            <i class="bi bi-person-fill me-1"></i>
                                            {{ item.aluno.nome_completo|title }}
                                        </span>
                                    {% endif %}
                                </a>
                                {% if not forloop.last %}<br>{% endif %}
                            {% endfor %}
                        {% else %}
                            {% for aluno in aula.alunos.all %}
                                <a href="{% url 'scheduler:aluno_detalhe' aluno.pk %}" class="text-decoration-none d-inline-block mb-1">
                                    <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle d-inline-flex align-items-center" data-bs-toggle="tooltip" title="Aluno agendado">
                                        <i class="bi bi-person-fill me-1"></i>
                                        {{ aluno.nome_completo|title }}
                                    </span>
                                </a>
                                {% if not forloop.last %}<br>{% endif %}
                            {% empty %}
                                <span class="text-muted">--</span>
                            {% endfor %}
                        {% endif %}
                    </td>

                    <td>{{ aula.modalidade.nome|title }}</td>
                    
                    <td class="align-top" data-label="Prof. Atribuído(s)">
                        {% if "atividade complementar" in aula.modalidade.nome|lower %}
                            <div class="d-flex flex-column gap-1">
                                {% for presenca in aula.presencas_professores.all %}
                                    <div class="d-flex align-items-center">
                                        {# ★★★ INÍCIO DA PADRONIZAÇÃO DOS BADGES DE PROFESSORES ★★★ #}
                                        {% if presenca.status == 'ausente' %}
                                            <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis border border-warning-subtle d-inline-flex align-items-center" data-bs-toggle="tooltip" title="Professor ausente">
                                                <i class="bi bi-person-x-fill me-1"></i>
                                                <span class="text-decoration-line-through">{{ presenca.professor.username|title }}</span>
                                            </span>
                                        {% else %}
                                            {% if user.tipo == 'admin' %}
                                                <a href="{% url 'scheduler:professor_detalhe' presenca.professor.pk %}" class="text-decoration-none">
                                                    <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle d-inline-flex align-items-center" data-bs-toggle="tooltip" title="Professor presente">
                                                        <i class="bi bi-person-check-fill me-1"></i>
                                                        {{ presenca.professor.username|title }}
                                                    </span>
                                                </a>
                                            {% else %}
                                                <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle d-inline-flex align-items-center" data-bs-toggle="tooltip" title="Professor presente">
                                                    <i class="bi bi-person-check-fill me-1"></i>
                                                    {{ presenca.professor.username|title }}
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                        {# ★★★ FIM DA PADRONIZAÇÃO ★★★ #}
                                    </div>
                                {% empty %}
                                    <span class="text-muted small">Nenhum participante</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="d-flex flex-column gap-1">
                                {% for prof in aula.professores.all %}
                                    {% if user.tipo == 'admin' %}
                                        <a href="{% url 'scheduler:professor_detalhe' prof.pk %}" 
                                           class="badge text-bg-secondary opacity-75 hover-grow d-inline-flex align-items-center py-1"
                                           data-bs-toggle="tooltip" title="Professor designado">
                                            <i class="bi bi-person-fill me-1"></i>
                                            {{ prof.username|title }}
                                        </a>
                                    {% else %}
                                        <span class="badge text-bg-secondary opacity-75 d-inline-flex align-items-center py-1">
                                            <i class="bi bi-person-fill me-1"></i>
                                            {{ prof.username|title }}
                                        </span>
                                    {% endif %}
                                {% empty %}
                                    <span class="text-muted small">Não Atribuído</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </td>
                    
                    <td class="align-middle" data-label="Status">
                        <div class="d-flex flex-column gap-2">
                            {% if aula.status == 'Realizada' %}
                                {% if aula.foi_substituida %}
                                    <span class="badge text-bg-secondary shake-on-hover" data-bs-toggle="tooltip" title="Aula realizada por substituto"><i class="bi bi-arrow-repeat me-1"></i>Substituído</span>
                                {% else %}
                                    <span class="badge text-bg-success pulse-once" data-bs-toggle="tooltip" title="Aula concluída conforme planejado"><i class="bi bi-check-circle-fill me-1"></i>Realizada</span>
                                {% endif %}
                            {% elif aula.status == 'Agendada' %}
                                <span class="badge text-bg-info pulse-slow" data-bs-toggle="tooltip" title="Aula agendada"><i class="bi bi-clock-history me-1"></i>Agendada</span>
                            {% elif aula.status == 'Cancelada' %}
                                <span class="badge text-bg-danger" data-bs-toggle="tooltip" title="Aula cancelada"><i class="bi bi-x-circle-fill me-1"></i>Cancelada</span>
                            {% elif aula.status == 'Aluno Ausente' %}
                                <span class="badge text-bg-warning" data-bs-toggle="tooltip" title="Aluno(s) não compareceu(ram)"><i class="bi bi-exclamation-triangle-fill me-1"></i>Aluno Ausente</span>
                            {% else %}
                                <span class="badge text-bg-secondary">{{ aula.status }}</span>
                            {% endif %}
                            
                            {% if aula.status == 'Realizada' and aula.relatorioaula.professor_que_validou %}
                                <div class="d-flex align-items-center gap-1">
                                    <small class="text-muted">Por:</small>
                                    {% if aula.relatorioaula.professor_que_validou in aula.professores.all %}
                                        <span class="badge text-bg-success">{{ aula.relatorioaula.professor_que_validou.username|title }}</span>
                                    {% else %}
                                        <span class="badge text-bg-secondary">{{ aula.relatorioaula.professor_que_validou.username|title }}</span>
                                    {% endif %}
                                </div>
                            {% elif aula.status != 'Cancelada' and aula.status != 'Aluno Ausente' and not aula.relatorioaula.professor_que_validou %}
                                <span class="badge text-bg-info pulse-slow"><i class="bi bi-hourglass-split me-1"></i>Aguardando</span>
                            {% endif %}
                        </div>
                    </td>
                    <td data-label="Data e Hora">{{ aula.data_hora|date:"d/m/Y, H:i" }}</td>
                    <td class="text-center" data-label="Ações">{% include 'scheduler/partials/aula_actions.html' with aula=aula %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{# --- 2. VISÃO DE MOBILE --- #}
<div class="d-lg-none vstack gap-3">
    {% for aula in aulas %}
    <div class="card shadow-sm mb-3 border-0 border-start border-4
                {% if aula.status == 'Agendada' and aula.data_hora < now %}border-danger
                {% elif aula.status == 'Realizada' %}border-success
                {% elif aula.status == 'Cancelada' %}border-danger
                {% elif aula.status == 'Aluno Ausente' %}border-warning
                {% elif aula.status == 'Agendada' %}border-info
                {% else %}border-secondary{% endif %}">
        
        {# ★★★ INÍCIO DA CORREÇÃO NO CABEÇALHO MOBILE ★★★ #}
        <div class="card-header text-center">
            <h5 class="card-title mb-1">
                {% if "atividade complementar" in aula.modalidade.nome|lower %}
                    {{ aula.modalidade.nome|title }}
                {% else %}
                    {# Lógica principal que verifica se há dados de presença para exibir os badges corretos #}
                    {% if aula.status in "Realizada,Aluno Ausente" and aula.alunos_com_status %}
                        {% for item in aula.alunos_com_status %}
                            {% if user.tipo == 'admin' %}
                                <a href="{% url 'scheduler:aluno_detalhe' item.aluno.pk %}" class="text-decoration-none d-inline-block mb-1">
                                    <span class="badge rounded-pill {% if item.status == 'presente' %}bg-success-subtle text-success-emphasis border border-success-subtle{% elif item.status == 'ausente' %}bg-warning-subtle text-warning-emphasis border border-warning-subtle{% else %}bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle{% endif %} d-inline-flex align-items-center">
                                        <i class="bi {% if item.status == 'presente' %}bi-person-check-fill{% elif item.status == 'ausente' %}bi-person-x-fill{% else %}bi-person-fill{% endif %} me-1"></i>
                                        {{ item.aluno.nome_completo|title }}
                                    </span>
                                </a>
                            {% else %}
                                <span class="badge rounded-pill {% if item.status == 'presente' %}bg-success-subtle text-success-emphasis border border-success-subtle{% elif item.status == 'ausente' %}bg-warning-subtle text-warning-emphasis border border-warning-subtle{% else %}bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle{% endif %} d-inline-flex align-items-center d-inline-block mb-1">
                                    <i class="bi {% if item.status == 'presente' %}bi-person-check-fill{% elif item.status == 'ausente' %}bi-person-x-fill{% else %}bi-person-fill{% endif %} me-1"></i>
                                    {{ item.aluno.nome_completo|title }}
                                </span>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        {# Fallback para aulas agendadas (mostra o badge cinza padrão) #}
                        {% for aluno in aula.alunos.all %}
                            {% if user.tipo == 'admin' %}
                                <a href="{% url 'scheduler:aluno_detalhe' aluno.pk %}" class="text-decoration-none d-inline-block mb-1">
                                    <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle d-inline-flex align-items-center" data-bs-toggle="tooltip" title="Aluno agendado">
                                        <i class="bi bi-person-fill me-1"></i>
                                        {{ aluno.nome_completo|title }}
                                    </span>
                                </a>
                            {% else %}
                                 <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle d-inline-flex align-items-center d-inline-block mb-1" data-bs-toggle="tooltip" title="Aluno agendado">
                                    <i class="bi bi-person-fill me-1"></i>
                                    {{ aluno.nome_completo|title }}
                                </span>
                            {% endif %}
                        {% empty %}
                            {{ aula.modalidade.nome|title }}
                        {% endfor %}
                    {% endif %}
                {% endif %}
            </h5>
            
            <div class="d-flex justify-content-center align-items-center gap-2 small">
                <span class="text-muted">{{ aula.data_hora|date:"d/m/Y, H:i" }}</span>
                
                {% if aula.status == 'Agendada' and aula.data_hora < now %}<span class="badge text-bg-danger pulse-slow"><i class="bi bi-exclamation-triangle-fill me-1"></i>Pendente</span>
                {% elif aula.status == 'Realizada' %}<span class="badge text-bg-success"><i class="bi bi-check-circle-fill me-1"></i>Realizada</span>
                {% elif aula.status == 'Agendada' %}<span class="badge text-bg-info"><i class="bi bi-clock-history me-1"></i>Agendada</span>
                {% elif aula.status == 'Cancelada' %}<span class="badge text-bg-danger"><i class="bi bi-x-circle-fill me-1"></i>Cancelada</span>
                {% elif aula.status == 'Aluno Ausente' %}<span class="badge text-bg-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>Aluno Ausente</span>
                {% endif %}
            </div>
        </div>
        
        <div class="card-body small pt-2">
            <p class="mb-2"><strong>Categoria:</strong> {{ aula.modalidade.nome|title }}</p>
            <div class="mb-2">
                <strong>Participantes:</strong>
                <div class="d-flex flex-wrap gap-1 mt-1">
                    {% if "atividade complementar" in aula.modalidade.nome|lower %}
                         {% for presenca in aula.presencas_professores.all %}
                            {# ★ Lógica de permissão para o link do professor ★ #}
                            {% if user.tipo == 'admin' %}
                                <a href="{% url 'scheduler:professor_detalhe' presenca.professor.pk %}" class="text-decoration-none">
                                    <span class="badge rounded-pill {% if presenca.status == 'ausente' %}bg-warning-subtle text-warning-emphasis border border-warning-subtle{% else %}bg-success-subtle text-success-emphasis border border-success-subtle{% endif %} d-inline-flex align-items-center">
                                        <i class="bi {% if presenca.status == 'ausente' %}bi-person-x-fill{% else %}bi-person-check-fill{% endif %} me-1"></i>
                                        {% if presenca.status == 'ausente' %}<span class="text-decoration-line-through">{{ presenca.professor.username|title }}</span>{% else %}{{ presenca.professor.username|title }}{% endif %}
                                    </span>
                                </a>
                            {% else %}
                                <span class="badge rounded-pill {% if presenca.status == 'ausente' %}bg-warning-subtle text-warning-emphasis border border-warning-subtle{% else %}bg-success-subtle text-success-emphasis border border-success-subtle{% endif %} d-inline-flex align-items-center">
                                    <i class="bi {% if presenca.status == 'ausente' %}bi-person-x-fill{% else %}bi-person-check-fill{% endif %} me-1"></i>
                                    {% if presenca.status == 'ausente' %}<span class="text-decoration-line-through">{{ presenca.professor.username|title }}</span>{% else %}{{ presenca.professor.username|title }}{% endif %}
                                </span>
                            {% endif %}
                        {% empty %}
                            <span class="text-muted small">N/A</span>
                        {% endfor %}
                    {% else %}
                        {% for prof in aula.professores.all %}
                            {% if user.tipo == 'admin' %}
                                <a href="{% url 'scheduler:professor_detalhe' prof.pk %}" class="text-decoration-none">
                                    <span class="badge text-bg-secondary opacity-75"><i class="bi bi-person-fill me-1"></i>{{ prof.username|title }}</span>
                                </a>
                            {% else %}
                                <span class="badge text-bg-secondary opacity-75"><i class="bi bi-person-fill me-1"></i>{{ prof.username|title }}</span>
                            {% endif %}
                        {% empty %}
                            <span class="text-muted small">N/A</span>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        {# ★ Ações agora usam o mesmo include da versão desktop para garantir consistência nas permissões ★ #}
        <div class="card-footer text-end">
            {% include 'scheduler/partials/aula_actions.html' with aula=aula %}
        </div>
    </div>
    {% endfor %}
</div>

{# CSS e JavaScript necessários (sem alterações) #}
<style>
    .hover-grow { transition: transform 0.2s ease; }
    .hover-grow:hover { transform: scale(1.05); }
    .pulse-once { animation: pulse 1s ease-in-out; }
    .pulse-slow { animation: pulse 2s infinite; }
    .shake-on-hover:hover { animation: shake 0.5s; }
    .table-responsive {
        overflow: hidden;
    }
    .table-hover > tbody > tr {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }

    .table-hover > tbody > tr:hover {
        transform: scale(1.015);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 10;
        position: relative;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.03); }
        100% { transform: scale(1); }
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-3px); }
        40%, 80% { transform: translateX(3px); }
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(el => new bootstrap.Tooltip(el));
    document.querySelectorAll('.status-updated').forEach(el => {
        el.classList.add('status-updated-highlight');
        setTimeout(() => el.classList.remove('status-updated-highlight'), 1000);
    });
});
</script>
{% endif %}