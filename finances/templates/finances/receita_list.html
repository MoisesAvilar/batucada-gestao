{% extends "scheduler/base.html" %}

{% block content %}
<style>
    /* Estilos específicos para a nova página de Contas a Receber */

    /* Cards de KPI (Key Performance Indicator) */
    .kpi-card {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color-translucent);
        border-radius: 0.75rem;
        padding: 1.25rem;
        height: 100%;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--bs-box-shadow);
    }
    .kpi-card .kpi-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--bs-emphasis-color);
    }
    .kpi-card .kpi-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--bs-secondary-color);
        text-transform: uppercase;
    }

    /* Cards de Receita (Visão Mobile) */
    .receita-card {
        border-width: 1px;
        border-left-width: 5px;
        transition: box-shadow 0.2s ease;
    }
    .receita-card.status-recebido { border-left-color: var(--bs-success); }
    .receita-card.status-a_receber { border-left-color: var(--bs-warning); }

    .receita-card:hover {
        box-shadow: var(--bs-box-shadow-sm);
    }

    .receita-card .card-footer {
        background-color: var(--bs-tertiary-bg);
    }

    /* Tabela Desktop */
    .table-hover > tbody > tr {
        transition: background-color 0.2s ease;
    }
</style>

<div class="d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center text-center text-lg-start gap-3 mb-4">
    <div>
        <h1 class="h3 mb-0">{{ titulo }}</h1>
        {% if filtro_ativo == 'a_vencer' %}
            <p class="text-muted mb-0">Mostrando apenas contas com vencimento nos próximos 5 dias.</p>
        {% endif %}
    </div>
    <div class="d-grid d-lg-block d-flex gap-2">
        {% if filtro_ativo == 'a_vencer' %}
            <a href="{% url 'finances:receita_list' %}" class="btn btn-outline-secondary"><i class="bi bi-x-lg me-1"></i> Limpar Filtro</a>
        {% endif %}
        <a href="{% url 'finances:aging_report' %}" class="btn btn-outline-secondary">
            <i class="bi bi-hourglass-split me-1"></i> Ver por Vencimento
        </a>
        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#escolherTipoReceitaModal">
            <i class="bi bi-plus-circle me-2"></i>Nova Receita
        </button>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6 col-xl-3">
        <a href="?status=a_receber" class="text-decoration-none">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label text-warning">A Receber</div>
                        <div class="kpi-value">R$ {{ total_a_receber|floatformat:2 }}</div>
                    </div>
                    <i class="bi bi-hourglass-split fs-2 text-warning opacity-50"></i>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-6 col-xl-3">
        <a href="?status=recebido" class="text-decoration-none">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label text-success">Recebido (no período)</div>
                        <div class="kpi-value">R$ {{ total_recebido|floatformat:2 }}</div>
                    </div>
                    <i class="bi bi-check2-circle fs-2 text-success opacity-50"></i>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-6 col-xl-3">
        <a href="{% url 'finances:recorrencia_list' %}" class="text-decoration-none">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label text-info">Receitas Recorrentes</div>
                        <div class="kpi-value">{{ total_recorrentes }}</div>
                    </div>
                    <i class="bi bi-arrow-repeat fs-2 text-info opacity-50"></i>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-6 col-xl-3">
        <a href="{% url 'finances:receita_list' %}?filtro=a_vencer" class="text-decoration-none">
            <div class="kpi-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label text-primary">A Vencer (5 dias)</div>
                        <div class="kpi-value">R$ {{ total_a_vencer|floatformat:2 }}</div>
                    </div>
                    <i class="bi bi-calendar-week fs-2 text-primary opacity-50"></i>
                </div>
            </div>
        </a>
    </div>
</div>


<div class="accordion mb-4" id="accordionFiltros">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltros" aria-expanded="false" aria-controls="collapseFiltros">
                <i class="bi bi-funnel me-2"></i> Filtros de Pesquisa
            </button>
        </h2>
        <div id="collapseFiltros" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionFiltros">
            <div class="accordion-body bg-body">
                <form method="GET" action="{% url 'finances:receita_list' %}">
                    <div class="row g-3">
                        <div class="col-md-6"><label for="descricao" class="form-label">Descrição</label><input type="text" name="descricao" id="descricao" class="form-control" value="{{ filtros_aplicados.descricao }}"></div>
                        <div class="col-md-3"><label for="status" class="form-label">Status</label><select name="status" id="status" class="form-select"><option value="">Todos</option>{% for value, display in status_choices %}<option value="{{ value }}" {% if filtros_aplicados.status == value %}selected{% endif %}>{{ display }}</option>{% endfor %}</select></div>
                         <div class="col-md-3"><label for="categoria" class="form-label">Categoria</label><select name="categoria" id="categoria" class="form-select"><option value="">Todas</option>{% for cat in categorias %}<option value="{{ cat.pk }}" {% if filtros_aplicados.categoria|stringformat:"s" == cat.pk|stringformat:"s" %}selected{% endif %}>{{ cat.name|title }}</option>{% endfor %}</select></div>
                        <div class="col-md-6"><label for="aluno" class="form-label">Aluno</label><select name="aluno" id="aluno" class="form-select"><option value="">Todos</option>{% for al in alunos %}<option value="{{ al.pk }}" {% if filtros_aplicados.aluno|stringformat:"s" == al.pk|stringformat:"s" %}selected{% endif %}>{{ al.nome_completo|title }}</option>{% endfor %}</select></div>
                        <div class="col-md-3"><label for="data_inicial" class="form-label">De</label><input type="date" name="data_inicial" id="data_inicial" class="form-control" value="{{ filtros_aplicados.data_inicial }}"></div>
                        <div class="col-md-3"><label for="data_final" class="form-label">Até</label><input type="date" name="data_final" id="data_final" class="form-control" value="{{ filtros_aplicados.data_final }}"></div>
                    </div>
                    <div class="mt-3 text-end"><a href="{% url 'finances:receita_list' %}" class="btn btn-outline-secondary">Limpar Filtros</a><button type="submit" class="btn btn-primary"><i class="bi bi-search me-2"></i>Filtrar</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="content-block">
    {% if not page_obj %}
        <div class="text-center text-muted p-4">Nenhuma receita encontrada para os filtros aplicados.</div>
    {% else %}
        <div class="d-none d-lg-block">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Descrição</th>
                            <th scope="col">Aluno</th>
                            <th scope="col">Competência</th>
                            <th scope="col">Status</th>
                            <th scope="col">Valor</th>
                            <th scope="col">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in page_obj %}
                        <tr>
                            <td class="text-center">{{ page_obj.start_index|add:forloop.counter0 }}</td>
                            <td>
                                <span class="fw-bold">{{ r.descricao|title }}</span><br>
                                <small class="text-muted">{{ r.categoria.name|title }}</small>
                            </td>
                            <td>{{ r.aluno.nome_completo|title|default:"--" }}</td>
                            <td class="text-center">{{ r.data_competencia|date:"M/Y" }}</td>
                            <td class="text-center">
                                {% if r.status == 'recebido' %}
                                    <span class="badge bg-success-subtle text-success-emphasis rounded-pill"><i class="bi bi-check-circle-fill me-1"></i>Recebido</span>
                                {% else %}
                                    <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill"><i class="bi bi-hourglass-split me-1"></i>A Receber</span>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold">R$ {{ r.valor|floatformat:2 }}</td>
                            <td class="text-center">
                                <div class="btn-group">
                                    {% if r.status == 'a_receber' %}
                                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#baixarReceitaModal-{{ r.pk }}">Receber</button>
                                        <button type="button" class="btn btn-sm btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"><span class="visually-hidden">Mais</span></button>
                                    {% else %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                    {% endif %}
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#editReceitaModal" data-url="{% if r.produto %}{% url 'finances:edit_venda' r.pk %}{% else %}{% url 'finances:edit_mensalidade' r.pk %}{% endif %}"><i class="bi bi-pencil-square me-2"></i>Editar</button></li>
                                        <li><button class="dropdown-item text-danger" type="button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{% url 'finances:delete_receita' r.pk %}"><i class="bi bi-trash me-2"></i>Excluir</button></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="d-lg-none">
            <div class="vstack gap-3">
                {% for r in page_obj %}
                <div class="card shadow-sm receita-card status-{{ r.status }}">
                    <div class="card-body">
                        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="card-title mb-0 fw-bold">{{ r.descricao|title }}</h6>
                                <small class="text-muted">{{ r.categoria.name|title }}</small>
                            </div>
                            <span class="fw-bold fs-5 mt-2 mt-sm-0">R$ {{ r.valor|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center text-muted small">
                            <span><i class="bi bi-person me-1"></i> {{ r.aluno.nome_completo|title|default:"N/A" }}</span>
                            <span><i class="bi bi-calendar-event me-1"></i> {{ r.data_competencia|date:"M/Y" }}</span>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <div>
                            {% if r.status == 'recebido' %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill"><i class="bi bi-check-circle-fill me-1"></i>Recebido</span>
                            {% else %}
                                <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill"><i class="bi bi-hourglass-split me-1"></i>A Receber</span>
                            {% endif %}
                        </div>
                        <div class="btn-group">
                            {% if r.status == 'a_receber' %}
                                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#baixarReceitaModal-{{ r.pk }}">Receber</button>
                                <button type="button" class="btn btn-sm btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"><span class="visually-hidden">Mais</span></button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                            {% endif %}
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#editReceitaModal" data-url="{% if r.produto %}{% url 'finances:edit_venda' r.pk %}{% else %}{% url 'finances:edit_mensalidade' r.pk %}{% endif %}"><i class="bi bi-pencil-square me-2"></i>Editar</button></li>
                                <li><button class="dropdown-item text-danger" type="button" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-delete-url="{% url 'finances:delete_receita' r.pk %}"><i class="bi bi-trash me-2"></i>Excluir</button></li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="mt-4">
            {% include "scheduler/partials/pagination.html" %}
        </div>
    {% endif %}
</div>


<div class="modal fade" id="escolherTipoReceitaModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Receita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="lead">Qual tipo de receita você deseja adicionar?</p>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <button type="button" class="btn btn-primary btn-lg px-4 gap-3" data-bs-toggle="modal" data-bs-target="#addMensalidadeModal">
                        <i class="bi bi-person-circle me-2"></i>Lançar Mensalidade
                    </button>
                    <button type="button" class="btn btn-success btn-lg px-4" data-bs-toggle="modal" data-bs-target="#addVendaModal">
                        <i class="bi bi-cart3 me-2"></i>Registrar Venda
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addMensalidadeModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Nova Mensalidade</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addMensalidadeForm" action="{% url 'finances:add_mensalidade' %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="{{ mensalidade_form.aluno.id_for_label }}" class="form-label">{{ mensalidade_form.aluno.label }}</label>
                        {{ mensalidade_form.aluno }}
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ mensalidade_form.descricao.id_for_label }}" class="form-label">{{ mensalidade_form.descricao.label }}</label>
                            {{ mensalidade_form.descricao }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ mensalidade_form.valor.id_for_label }}" class="form-label">{{ mensalidade_form.valor.label }}</label>
                            {{ mensalidade_form.valor }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ mensalidade_form.categoria.id_for_label }}" class="form-label">{{ mensalidade_form.categoria.label }}</label>
                        <div class="input-group">
                            {{ mensalidade_form.categoria }}
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#addCategoryModal" data-category-type="income" title="Adicionar Nova Categoria">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ mensalidade_form.data_competencia.id_for_label }}" class="form-label">{{ mensalidade_form.data_competencia.label }}</label>
                            {{ mensalidade_form.data_competencia }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ mensalidade_form.data_recebimento.id_for_label }}" class="form-label">{{ mensalidade_form.data_recebimento.label }} (Opcional)</label>
                            {{ mensalidade_form.data_recebimento }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Mensalidade</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="addVendaModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Nova Venda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addVendaForm" action="{% url 'finances:add_venda' %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ venda_form.produto.id_for_label }}" class="form-label">{{ venda_form.produto.label }}</label>
                            {{ venda_form.produto }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ venda_form.quantidade.id_for_label }}" class="form-label">{{ venda_form.quantidade.label }}</label>
                            <div class="input-group">
                                {{ venda_form.quantidade }}
                                <span class="input-group-text" id="estoque-info"></span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-8 mb-3">
                            <label for="{{ venda_form.descricao.id_for_label }}" class="form-label">{{ venda_form.descricao.label }}</label>
                            {{ venda_form.descricao }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ venda_form.valor.id_for_label }}" class="form-label">{{ venda_form.valor.label }}</label>
                            {{ venda_form.valor }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ venda_form.categoria.id_for_label }}" class="form-label">{{ venda_form.categoria.label }}</label>
                        <div class="input-group">
                            {{ venda_form.categoria }}
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#addCategoryModal" data-category-type="income" title="Adicionar Nova Categoria">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ venda_form.aluno.id_for_label }}" class="form-label">{{ venda_form.aluno.label }}</label>
                        {{ venda_form.aluno }}
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ venda_form.data_competencia.id_for_label }}" class="form-label">{{ venda_form.data_competencia.label }}</label>
                            {{ venda_form.data_competencia }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ venda_form.data_recebimento.id_for_label }}" class="form-label">{{ venda_form.data_recebimento.label }} (Opcional)</label>
                            {{ venda_form.data_recebimento }}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Registrar Venda</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editReceitaModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReceitaModalTitle">Editar Receita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editReceitaForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    
                    <div id="edit-venda-fields" style="display: none;">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="{{ venda_form.produto.id_for_label }}" class="form-label">{{ venda_form.produto.label }}</label>
                                {{ venda_form.produto }}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ venda_form.quantidade.id_for_label }}" class="form-label">{{ venda_form.quantidade.label }}</label>
                                <div class="input-group">
                                    {{ venda_form.quantidade }}
                                    <span class="input-group-text" id="edit-estoque-info"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="edit-mensalidade-fields" style="display: none;">
                        <div class="mb-3">
                            <label for="{{ mensalidade_form.aluno.id_for_label }}" class="form-label">{{ mensalidade_form.aluno.label }}</label>
                            {{ mensalidade_form.aluno }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ mensalidade_form.descricao.id_for_label }}" class="form-label">{{ mensalidade_form.descricao.label }}</label>
                            {{ mensalidade_form.descricao }}
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="{{ mensalidade_form.valor.id_for_label }}" class="form-label">{{ mensalidade_form.valor.label }}</label>
                            {{ mensalidade_form.valor }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ mensalidade_form.categoria.id_for_label }}" class="form-label">{{ mensalidade_form.categoria.label }}</label>
                        <div class="input-group">
                            {{ mensalidade_form.categoria }}
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#addCategoryModal" data-category-type="income" title="Adicionar Nova Categoria">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ mensalidade_form.data_competencia.id_for_label }}" class="form-label">{{ mensalidade_form.data_competencia.label }}</label>
                            {{ mensalidade_form.data_competencia }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ mensalidade_form.data_recebimento.id_for_label }}" class="form-label">{{ mensalidade_form.data_recebimento.label }} (Opcional)</label>
                            {{ mensalidade_form.data_recebimento }}
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalTitle">Nova Categoria</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm" action="{% url 'finances:add_category_ajax' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="type" id="id_type_modal">

                    <div class="mb-3">
                        <label for="id_name_modal" class="form-label">Nome da Categoria</label>
                        <input type="text" name="name" class="form-control" id="id_name_modal" required>
                    </div>

                    <div id="tipo-dre-container" class="mb-3" style="display: none;">
                        <label class="form-label">Classificar como:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="tipo_dre" id="id_tipo_dre_custo" value="custo" autocomplete="off">
                            <label for="id_tipo_dre_custo" class="btn btn-outline-primary w-100">Custo Direto</label>

                            <input type="radio" class="btn-check" name="tipo_dre" id="id_tipo_dre_despesa" value="despesa" autocomplete="off" checked>
                            <label for="id_tipo_dre_despesa" class="btn btn-outline-primary w-100">Despesa Operacional</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="submitCategoryFormBtn" form="addCategoryForm">Salvar Categoria</button>
            </div>
        </div>
    </div>
</div>

{% for r in page_obj %}
<div class="modal fade" id="baixarReceitaModal-{{ r.pk }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Recebimento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'finances:baixar_receita' r.pk %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Confirmar o recebimento de <strong>{{ r.descricao|title }}</strong> no valor de <strong>R$ {{ r.valor|floatformat:2 }}</strong>?</p>
                    <div class="mb-3">
                        <label for="data_recebimento-{{ r.pk }}" class="form-label">Data do Recebimento:</label>
                        <input type="date" name="data_recebimento" id="data_recebimento-{{ r.pk }}" class="form-control" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar Recebimento</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- MODAL ADICIONAR MENSALIDADE ---
    const addMensalidadeModal = document.getElementById('addMensalidadeModal');
    if (addMensalidadeModal) {
        const alunoSelect = addMensalidadeModal.querySelector('[name*="aluno"]');
        const descricaoInput = addMensalidadeModal.querySelector('[name*="descricao"]');
        const valorInput = addMensalidadeModal.querySelector('[name*="valor"]');
        const dataCompetenciaInput = addMensalidadeModal.querySelector('[name*="data_competencia"]');

        alunoSelect.addEventListener('change', function() {
            const alunoId = this.value;
            if (!alunoId) return;

            fetch(`/finances/ajax/get-aluno-details/${alunoId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.nome_completo) descricaoInput.value = `Mensalidade de ${data.nome_completo}`;
                    if (data.valor_mensalidade !== undefined) valorInput.value = parseFloat(data.valor_mensalidade).toFixed(2);
                    if(data.dia_vencimento) {
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = String(today.getMonth() + 1).padStart(2, '0');
                        const day = String(data.dia_vencimento).padStart(2, '0');
                        dataCompetenciaInput.value = `${year}-${month}-${day}`;
                    }
                })
                .catch(err => console.error("Erro ao buscar detalhes do aluno:", err));
        });
    }

    // --- MODAL ADICIONAR VENDA ---
    const addVendaModal = document.getElementById('addVendaModal');
    if (addVendaModal) {
        const produtoSelect = addVendaModal.querySelector('[name*="produto"]');
        const quantidadeInput = addVendaModal.querySelector('[name*="quantidade"]');
        const valorInput = addVendaModal.querySelector('[name*="valor"]');
        const descricaoInput = addVendaModal.querySelector('[name*="descricao"]');
        const estoqueInfo = addVendaModal.querySelector('#estoque-info');

        function atualizarDetalhesProduto() {
            const produtoId = produtoSelect.value;
            if (!produtoId) {
                valorInput.value = '';
                descricaoInput.value = '';
                estoqueInfo.textContent = '';
                return;
            }

            fetch(`/store/ajax/get-produto-details/${produtoId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) return;
                    const precoUnitario = parseFloat(data.preco);
                    const quantidade = parseInt(quantidadeInput.value) || 1;
                    valorInput.value = (precoUnitario * quantidade).toFixed(2);
                    descricaoInput.value = `Venda: ${produtoSelect.options[produtoSelect.selectedIndex].text}`;
                    estoqueInfo.textContent = `${data.estoque} em estoque`;
                    quantidadeInput.max = data.estoque;
                })
                .catch(err => console.error("Erro ao buscar detalhes do produto:", err));
        }

        produtoSelect.addEventListener('change', atualizarDetalhesProduto);
        quantidadeInput.addEventListener('input', atualizarDetalhesProduto);
    }

    // --- MODAIS DE EDIÇÃO ---
    function setupEditModal(modalId, formId, attributeName) {
        const editModalEl = document.getElementById(modalId);
        if (!editModalEl) return;

        const editForm = document.getElementById(formId);
        const modalTitleEl = document.getElementById('editReceitaModalTitle');
        
        // Divs dos campos específicos
        const vendaFields = document.getElementById('edit-venda-fields');
        const mensalidadeFields = document.getElementById('edit-mensalidade-fields');
        
        // Elementos do formulário de venda
        const produtoSelect = vendaFields.querySelector('[name="produto"]');
        const quantidadeInput = vendaFields.querySelector('[name="quantidade"]');
        const valorInput = editForm.querySelector('[name="valor"]');
        const descricaoInput = editForm.querySelector('[name="descricao"]');
        const estoqueInfo = vendaFields.querySelector('#edit-estoque-info');

        // Função para atualizar detalhes do produto (preço, estoque, etc.)
        function atualizarDetalhesProdutoVenda() {
            const produtoId = produtoSelect.value;
            if (!produtoId) return;

            fetch(`/store/ajax/get-produto-details/${produtoId}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) return;
                    const precoUnitario = parseFloat(data.preco);
                    const quantidade = parseInt(quantidadeInput.value) || 1;
                    valorInput.value = (precoUnitario * quantidade).toFixed(2);
                    if (!descricaoInput.value) {
                        descricaoInput.value = `Venda: ${produtoSelect.options[produtoSelect.selectedIndex].text}`;
                    }
                    estoqueInfo.textContent = `${data.estoque} em estoque`;
                    quantidadeInput.max = data.estoque;
                })
                .catch(err => console.error("Erro ao buscar detalhes do produto:", err));
        }

        editModalEl.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            if (!button) return;
            const url = button.getAttribute(attributeName);
            if (!url) return;

            editForm.setAttribute('action', url);
            
            // Limpa e reseta os listeners para evitar duplicação
            produtoSelect.removeEventListener('change', atualizarDetalhesProdutoVenda);
            quantidadeInput.removeEventListener('input', atualizarDetalhesProdutoVenda);

            // Verifica se é Venda ou Mensalidade pela URL
            if (url.includes('/venda/')) {
                modalTitleEl.textContent = 'Editar Venda';
                vendaFields.style.display = 'block';
                mensalidadeFields.style.display = 'none';
                // Adiciona os listeners para os campos de produto/quantidade
                produtoSelect.addEventListener('change', atualizarDetalhesProdutoVenda);
                quantidadeInput.addEventListener('input', atualizarDetalhesProdutoVenda);
            } else {
                modalTitleEl.textContent = 'Editar Mensalidade';
                vendaFields.style.display = 'none';
                mensalidadeFields.style.display = 'block';
            }

            // Carrega os dados existentes no formulário
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    // Limpa todos os campos antes de preencher
                    editForm.reset();
                    for (const key in data) {
                        const field = editForm.querySelector(`[name="${key}"]`);
                        if (field) {
                            field.value = data[key];

                            // Se for uma venda, dispara a atualização do estoque/preço
                            if (url.includes('/venda/') && (key === 'produto' || key === 'quantidade')) {
                                // Dispara um 'change' para carregar os dados do produto
                                field.dispatchEvent(new Event('change', { 'bubbles': true }));
                            }
                        }
                    }
                })
                .catch(err => console.error("Erro ao carregar dados para edição:", err));
        });

        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(editForm);
            const url = editForm.getAttribute('action');

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    let error_message = data.message || 'Ocorreu um erro ao salvar.';
                    if(data.errors) {
                        // Formata os erros para melhor leitura
                        let errorsStr = Object.entries(data.errors).map(([key, value]) => `${key}: ${value}`).join('\n');
                        error_message += '\n\nDetalhes:\n' + errorsStr;
                    }
                    alert(error_message);
                }
            })
            .catch(err => console.error("Erro de comunicação ao salvar:", err));
        });
    }

    setupEditModal('editReceitaModal', 'editReceitaForm', 'data-url');

    // --- DATA ATUAL NO MODAL DE RECEBIMENTO ---
    document.querySelectorAll('[id^="baixarReceitaModal-"]').forEach(modal => {
        modal.addEventListener('show.bs.modal', function() {
            const dateInput = modal.querySelector('input[type="date"]');
            if(dateInput) dateInput.value = new Date().toISOString().split('T')[0];
        });
    });

    // --- MODAL DE CATEGORIA ---
    const addCategoryModalEl = document.getElementById('addCategoryModal');
    if (addCategoryModalEl) {
        const categoryForm = document.getElementById('addCategoryForm');
        const addCategoryModalInstance = new bootstrap.Modal(addCategoryModalEl);
        
        // Elementos do formulário
        const nameInput = addCategoryModalEl.querySelector('#id_name_modal');
        const errorContainer = addCategoryModalEl.querySelector('#category-name-error');
        const typeInput = addCategoryModalEl.querySelector('#id_type_modal');
        const tipoDreContainer = addCategoryModalEl.querySelector('#tipo-dre-container');
        const modalTitle = addCategoryModalEl.querySelector('#addCategoryModalTitle');
        const submitButton = addCategoryModalEl.querySelector('#submitCategoryFormBtn');

        let activeParentModal = null;
        let activeCategorySelect = null;

        // Limpa o estado do formulário antes de abrir
        addCategoryModalEl.addEventListener('show.bs.modal', function(event) {
            categoryForm.reset();
            nameInput.classList.remove('is-invalid');
            if (errorContainer) errorContainer.textContent = '';

            const button = event.relatedTarget;
            if (button) {
                activeParentModal = button.closest('.modal');
                activeCategorySelect = button.closest('.input-group').querySelector('select');

                const categoryType = button.getAttribute('data-category-type');
                typeInput.value = categoryType;
                
                tipoDreContainer.style.display = categoryType === 'expense' ? 'block' : 'none';
                modalTitle.textContent = (categoryType === 'expense') ? 'Nova Categoria de Saída' : 'Nova Categoria de Entrada';
            }
        });

        // Manipula o envio do formulário
        categoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            const formData = new FormData(categoryForm);
            const url = categoryForm.action;

            // Limpa erros antigos e mostra spinner
            nameInput.classList.remove('is-invalid');
            if (errorContainer) errorContainer.textContent = '';
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...`;

            fetch(url, { method: 'POST', body: formData, headers: {'X-Requested-With': 'XMLHttpRequest'} })
            .then(response => {
                if (!response.ok) {
                    // Se a resposta for um erro (como 400 ou 500), tenta ler como JSON
                    return response.json().then(errData => Promise.reject(errData));
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    // Adiciona a nova categoria a TODOS os <select> de categoria da página
                    const newOption = new Option(data.name.charAt(0).toUpperCase() + data.name.slice(1), data.id, false, true);
                    document.querySelectorAll('select[name="categoria"]').forEach(select => {
                        select.appendChild(newOption.cloneNode(true));
                    });
                    
                    // Seleciona a nova categoria no <select> que abriu o modal
                    if (activeCategorySelect) {
                        activeCategorySelect.value = data.id;
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
                } 
                // Esta parte nunca deveria ser alcançada se a validação falhar,
                // pois a resposta terá status 400 e cairá no .catch()
            })
            .catch(errorData => {
                // Trata erros de validação (status 400) ou outros erros
                if (errorData.errors && errorData.errors.name) {
                    nameInput.classList.add('is-invalid');
                    if (errorContainer) errorContainer.textContent = errorData.errors.name[0];
                } else {
                    alert('Ocorreu um erro inesperado. Tente novamente.');
                    console.error('Erro:', errorData);
                }
            })
            .finally(() => {
                // Restaura o botão
                submitButton.disabled = false;
                submitButton.innerHTML = 'Salvar Categoria';
            });
        });

        // Reabre o modal pai após fechar o de categoria
        addCategoryModalEl.addEventListener('hidden.bs.modal', function() {
            if (activeParentModal) {
                // Pega a instância do modal pai que estava ativo
                const parentModalInstance = bootstrap.Modal.getInstance(activeParentModal);
                if (parentModalInstance) {
                    // --- LINHA ADICIONADA ---
                    // Usa um pequeno delay para garantir que a animação de fechar termine
                    setTimeout(() => {
                        parentModalInstance.show();
                    }, 200); 
                }
            }
            // Limpa as variáveis de controle
            activeParentModal = null;
            activeCategorySelect = null;
        });
    }

});
</script>
{% endblock %}
