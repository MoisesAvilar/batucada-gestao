{% extends "scheduler/base.html" %}

{% block content %}

<style>
    .transaction-income {
        --bs-table-bg: var(--bs-success-bg-subtle);
        --bs-table-color: var(--bs-success-text-emphasis);
    }
    .transaction-expense {
        --bs-table-bg: var(--bs-danger-bg-subtle);
        --bs-table-color: var(--bs-danger-text-emphasis);
    }
    .kpi-alert { transition: transform 0.2s ease-in-out; }
    .kpi-alert:hover { transform: translateY(-5px); }

        /* NOVO CSS PARA A TABELA */
    .transaction-icon {
        font-size: 1.5rem; /* Aumenta o tamanho do ícone */
    }

    .custom-table-cards .badge {
        font-size: 0.8em;
        padding: 0.4em 0.8em;
    }

    /* DESIGN RESPONSIVO PARA TRANSFORMAR EM CARDS */
    @media (max-width: 992px) {
        .custom-table-cards thead {
            display: none; /* Esconde o cabeçalho em telas menores */
        }
        .custom-table-cards tr {
            display: block;
            margin-bottom: 1.5rem;
            border: 1px solid var(--bs-border-color-translucent);
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }
        .custom-table-cards td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: none;
            padding: 0.5rem 0;
            text-align: right !important; /* Força o alinhamento do conteúdo */
        }
        .custom-table-cards td:not(:last-child) {
            border-bottom: 1px dashed var(--bs-border-color-translucent);
        }

        .custom-table-cards td::before {
            content: attr(data-label); /* Usa o atributo data-label como título */
            font-weight: bold;
            text-align: left;
            margin-right: 1rem;
        }

        /* Oculta labels que não fazem sentido no formato card */
        .custom-table-cards td[data-label="Tipo"]::before,
        .custom-table-cards td[data-label="Tipo"] {
            display: none; /* O ícone já é visual o suficiente */
        }
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h1 class="h3 mb-0">Dashboard Financeiro</h1>
</div>

<div class="content-block mb-4">
    <form method="get" class="row g-3 align-items-end">
        <div class="col-md-5"><label for="id_start_date" class="form-label small">De:</label><input type="date" name="start_date" id="id_start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}"></div>
        <div class="col-md-5"><label for="id_end_date" class="form-label small">Até:</label><input type="date" name="end_date" id="id_end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}"></div>
        <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Filtrar</button></div>
    </form>
</div>

{% if contas_vencidas_count > 0 or receitas_atrasadas_count > 0 %}
<div class="row g-4 mb-4">
    {% if contas_vencidas_count > 0 %}
    <div class="col-lg-6">
        <div class="alert alert-danger d-flex align-items-center shadow-sm">
            <i class="bi bi-exclamation-triangle-fill fs-2 me-3"></i>
            <div>
                <h5 class="alert-heading mb-0">{{ contas_vencidas_count }} Conta(s) Vencida(s)</h5>
                Totalizando <strong>R$ {{ contas_vencidas_total|floatformat:2 }}</strong>.
                <a href="{% url 'finances:despesa_list' %}?status=a_pagar&data_final={{ data_ontem|date:'Y-m-d' }}" class="alert-link stretched-link">Ver contas a pagar.</a>
            </div>
        </div>
    </div>
    {% endif %}

    {% if receitas_atrasadas_count > 0 %}
    <div class="col-lg-6">
        <div class="alert alert-warning d-flex align-items-center shadow-sm">
            <i class="bi bi-exclamation-circle-fill fs-2 me-3"></i>
            <div>
                <h5 class="alert-heading mb-0">{{ receitas_atrasadas_count }} Receita(s) Atrasada(s)</h5>
                Totalizando <strong>R$ {{ receitas_atrasadas_total|floatformat:2 }}</strong>.
                <a href="{% url 'finances:receita_list' %}?status=a_receber&data_final={{ data_ontem|date:'Y-m-d' }}" class="alert-link stretched-link">Ver contas a receber.</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="content-block text-center h-100">
            <h6 class="text-success text-uppercase small">Entradas (Realizadas)</h6>
            <h2 class="h1 mb-0">R$ {{ total_income|floatformat:2 }}</h2>
            <p class="mb-0 mt-2">
                <a href="{% url 'finances:receita_list' %}" class="text-warning-emphasis text-decoration-none">
                    <small>(+ R$ {{ total_a_receber|floatformat:2 }} a receber)</small>
                </a>
            </p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="content-block text-center h-100">
            <h6 class="text-danger text-uppercase small">Saídas (Pagas)</h6>
            <h2 class="h1 mb-0">R$ {{ total_expenses|floatformat:2 }}</h2>
            <p class="mb-0 mt-2">
                <a href="{% url 'finances:despesa_list' %}" class="text-danger-emphasis text-decoration-none">
                    <small>(+ R$ {{ total_a_pagar|floatformat:2 }} a pagar)</small>
                </a>
            </p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="content-block text-center h-100">
            <h6 class="text-info text-uppercase small">Saldo de Caixa (Atual)</h6>
            <h2 class="h1 mb-0">R$ {{ balance|floatformat:2 }}</h2>
            <p class="mb-0 mt-2 text-muted">
                <small>Resultado do período filtrado</small>
            </p>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="content-block">
            <h5 class="mb-3"><i class="bi bi-bar-chart-line-fill me-2"></i>Fluxo de Caixa no Período</h5>
            <div style="height: 350px;"><canvas id="cashFlowChart"></canvas></div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="content-block h-100">
            <h5 class="mb-3"><i class="bi bi-pie-chart-fill me-2 text-danger"></i>Saídas por Categoria</h5>
            {% if chart_data %}
                <div style="height: 300px;"><canvas id="expensesChart"></canvas></div>
            {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted small p-5">Sem dados de saídas para exibir.</div>
            {% endif %}
        </div>
    </div>
    <div class="col-lg-6">
        <div class="content-block h-100">
            <h5 class="mb-3"><i class="bi bi-pie-chart-fill me-2 text-success"></i>Entradas por Categoria</h5>
            {% if income_chart_data %}
                <div style="height: 300px;"><canvas id="incomeChart"></canvas></div>
            {% else %}
                <div class="d-flex align-items-center justify-content-center h-100 text-muted small p-5">Sem dados de entradas para exibir.</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="content-block h-100">
            <h5 class="mb-3"><i class="bi bi-trophy-fill me-2"></i>Top 5 Produtos Vendidos</h5>
            <ul class="list-group list-group-flush">
            {% for produto in top_produtos_vendidos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                    {{ produto.nome }}
                    {% if produto.categoria %}
                        <small class="d-block text-muted">{{ produto.categoria.nome }}</small>
                    {% endif %}
                    {% if produto.qtd_vendida %}
                        <small class="d-block text-muted">Qtd: {{ produto.qtd_vendida }}</small>
                    {% endif %}
                </span>
                <span class="badge bg-primary rounded-pill">R$ {{ produto.total_vendido|floatformat:2 }}</span>
            </li>
            {% empty %}
            <li class="list-group-item text-muted text-center small">Nenhuma venda de produto no período.</li>
            {% endfor %}
        </ul>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="content-block h-100">
            <h5 class="mb-3"><i class="bi bi-sort-down me-2"></i>Top 5 Maiores Despesas</h5>
            <ul class="list-group list-group-flush">
                {% for despesa in top_despesas %}
                 <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        {{ despesa.description }}
                        <small class="d-block text-muted">{{ despesa.category.name }}</small>
                    </span>
                    <span class="badge bg-danger rounded-pill">R$ {{ despesa.amount|floatformat:2 }}</span>
                </li>
                {% empty %}
                <li class="list-group-item text-muted text-center small">Nenhuma despesa no período.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<div class="content-block">
    <h5 class="mb-3"><i class="bi bi-list-ul me-2"></i>Histórico de Transações</h5>
    <div class="table-responsive">
        <table class="table table-hover align-middle custom-table-cards">
            <thead>
                <tr>
                    <th scope="col" style="width: 5%;">Tipo</th>
                    <th scope="col">Descrição</th>
                    <th scope="col">Associado a</th>
                    <th scope="col" class="text-end">Valor</th>
                    <th scope="col">Categoria</th>
                    <th scope="col">Data</th>
                    <th scope="col" class="text-end">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for t in page_obj %}
                <tr id="transaction-row-{{ t.pk }}">
                    <td data-label="Tipo">
                        {% if t.type == 'income' %}
                            <span class="transaction-icon text-success" title="Entrada"><i class="bi bi-arrow-up-circle-fill"></i></span>
                        {% elif t.type == 'expense' %}
                            <span class="transaction-icon text-danger" title="Saída"><i class="bi bi-arrow-down-circle-fill"></i></span>
                        {% endif %}
                    </td>
                    <td data-label="Descrição">
                        <span class="fw-bold">{{ t.description }}</span>
                    </td>
                    <td data-label="Associado a">
                        {% if t.student %}
                            <small class="d-block text-muted">{{ t.student.nome_completo }}</small>
                        {% elif t.professor %}
                            <small class="d-block text-muted">{{ t.professor.first_name }} {{ t.professor.last_name }}</small>
                        {% else %}
                            <span class="text-muted small">—</span>
                        {% endif %}
                    </td>
                    <td data-label="Valor" class="text-end">
                        <span class="fw-bold {% if t.type == 'income' %}text-success{% else %}text-danger{% endif %}">
                            R$ {{ t.amount|floatformat:2 }}
                        </span>
                    </td>
                    <td data-label="Categoria">
                        <span class="badge bg-secondary-subtle border border-secondary-subtle text-secondary-emphasis rounded-pill">
                            {{ t.category.name }}
                        </span>
                    </td>
                    <td data-label="Data">
                        <span class="text-muted">{{ t.transaction_date|date:"d/m/Y" }}</span>
                    </td>
                    <td data-label="Ações" class="text-end">
                        {% if t.receita %}
                            <a href="{% url 'finances:receita_list' %}?descricao={{ t.receita.descricao|urlencode }}" class="btn btn-sm btn-outline-secondary" title="Ver na lista de receitas">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        {% elif t.despesa %}
                            <a href="{% url 'finances:despesa_list' %}?descricao={{ t.despesa.descricao|urlencode }}" class="btn btn-sm btn-outline-secondary" title="Ver na lista de despesas">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-5">
                        Nenhum lançamento encontrado para o período.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% include 'scheduler/partials/pagination.html' with page_obj=page_obj request=request %}
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
{{ chart_labels|json_script:"chartLabels" }}
{{ chart_data|json_script:"chartData" }}
{{ income_chart_labels|json_script:"incomeChartLabels" }}
{{ income_chart_data|json_script:"incomeChartData" }}
{{ flow_chart_labels|json_script:"flowChartLabels" }}
{{ flow_chart_income_data|json_script:"flowChartIncomeData" }}
{{ flow_chart_expense_data|json_script:"flowChartExpenseData" }}
<script>
document.addEventListener('DOMContentLoaded', function() {    
    // Gráfico de Saídas (sem alteração)
    const expenseLabels = JSON.parse(document.getElementById('chartLabels').textContent);
    const expenseData = JSON.parse(document.getElementById('chartData').textContent);
    const expenseCtx = document.getElementById('expensesChart');
    if (expenseCtx && expenseData.length > 0) {
        new Chart(expenseCtx, {
            type: 'doughnut',
            data: {
                labels: expenseLabels,
                datasets: [{
                    label: 'Despesas', data: expenseData,
                    backgroundColor: ['#e74a3b', '#f6c23e', '#fd7e14', '#36b9cc', '#858796', '#4e73df', '#1cc88a'],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15 } } } }
        });
    }

    // --- NOVO GRÁFICO DE ENTRADAS ---
    const incomeLabels = JSON.parse(document.getElementById('incomeChartLabels').textContent);
    const incomeData = JSON.parse(document.getElementById('incomeChartData').textContent);
    const incomeCtx = document.getElementById('incomeChart');
    if (incomeCtx && incomeData.length > 0) {
        new Chart(incomeCtx, {
            type: 'doughnut',
            data: {
                labels: incomeLabels,
                datasets: [{
                    label: 'Entradas', data: incomeData,
                    backgroundColor: ['#1cc88a', '#4e73df', '#36b9cc', '#f6c23e', '#20c9a6', '#5a5c69' ],
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15 } } } }
        });
    }
    // --- FIM DO NOVO GRÁFICO ---

    // Gráfico de Fluxo de Caixa (sem alteração)
    const flowLabels = JSON.parse(document.getElementById('flowChartLabels').textContent);
    const flowIncome = JSON.parse(document.getElementById('flowChartIncomeData').textContent);
    const flowExpenses = JSON.parse(document.getElementById('flowChartExpenseData').textContent);
    const flowCtx = document.getElementById('cashFlowChart');

    if (flowCtx && flowLabels.length > 0) {
        new Chart(flowCtx, {
            type: 'bar',
            data: {
                labels: flowLabels,
                datasets: [
                    {
                        label: 'Entradas',
                        data: flowIncome,
                        backgroundColor: 'rgba(25, 135, 84, 0.6)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Saídas',
                        data: flowExpenses,
                        backgroundColor: 'rgba(220, 53, 69, 0.6)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }
});
</script>
{% endblock %}