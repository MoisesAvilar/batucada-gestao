{% extends "scheduler/base.html" %}
{% load humanize %}

{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-lg-between align-items-lg-center text-center text-lg-start gap-3 mb-4">
    <div>
        <h1 class="h3 mb-0">Itens da Categoria: {{ category_name }}</h1>
        <p class="text-muted mb-0">
            Exibindo lançamentos para o período de {{ start_date|date:"d/m" }} a {{ end_date|date:"d/m" }} de cada ano.
        </p>
    </div>
    <a href="{% url 'finances:dre_report' %}?{{ request.GET.urlencode }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Voltar para o DRE
    </a>
</div>

<div class="d-none d-lg-block content-block">
    <table class="table table-hover">
        <thead>
            <tr>
                <th scope="col">Descrição</th>
                <th scope="col">Competência</th>
                <th scope="col">{% if modelo == 'receita' %}Recebimento{% else %}Pagamento{% endif %}</th>
                <th scope="col">{% if modelo == 'receita' %}Aluno{% else %}Professor{% endif %}</th>
                <th scope="col" class="text-end">Valor</th>
            </tr>
        </thead>
        <tbody>
        {% for ano, dados in dados_agrupados %}
            <tr class="table-dark">
                <td colspan="5" class="fw-bold fs-5">
                    <i class="bi bi-calendar-event me-2"></i>Ano de {{ ano|stringformat:"d" }}
                </td>
            </tr>
            {% for lancamento in dados.itens %}
            <tr>
                <td>{{ lancamento.descricao|title }}</td>
                <td>{{ lancamento.data_competencia|date:"d/m/Y" }}</td>
                <td>
                    {% if modelo == 'receita' %}
                        {{ lancamento.data_recebimento|date:"d/m/Y"|default:"-" }}
                    {% else %}
                        {{ lancamento.data_pagamento|date:"d/m/Y"|default:"-" }}
                    {% endif %}
                </td>
                <td>
                    {% if modelo == 'receita' %}
                        {{ lancamento.aluno.nome_completo|title|default:"-" }}
                    {% else %}
                        {{ lancamento.professor.get_full_name|title|default:"-" }}
                    {% endif %}
                </td>
                <td class="text-end fw-bold">R$ {{ lancamento.valor|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
            <tr class="table-light">
                <td colspan="4" class="text-end fw-bold">Total de {{ ano|stringformat:"d" }}:</td>
                <td class="text-end fw-bold h6 mb-0">R$ {{ dados.total_ano|floatformat:2|intcomma }}</td>
            </tr>
        {% empty %}
             <tr>
                <td colspan="5" class="text-center text-muted p-4">
                    Nenhum lançamento encontrado para esta categoria.
                </td>
            </tr>
        {% endfor %}
        </tbody>
        {% if dados_agrupados %}
        <tfoot>
            <tr class="table-primary">
                <td colspan="4" class="text-end fw-bold">TOTAL GERAL:</td>
                <td class="text-end h5 mb-0">
                    R$ {{ total_geral|floatformat:2|intcomma }}
                </td>
            </tr>
        </tfoot>
        {% endif %}
    </table>
</div>

<div class="d-lg-none">
{% for ano, dados in dados_agrupados %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white fw-bold fs-5">
            <i class="bi bi-calendar-event me-2"></i>Ano de {{ ano|stringformat:"d" }}
        </div>
        <div class="list-group list-group-flush">
        {% for lancamento in dados.itens %}
            <div class="list-group-item">
                <h6 class="fw-bold mb-2">{{ lancamento.descricao|title }}</h6>
                <div class="d-flex justify-content-between mb-1">
                    <small class="text-muted">Competência:</small>
                    <small>{{ lancamento.data_competencia|date:"d/m/Y" }}</small>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <small class="text-muted">{% if modelo == 'receita' %}Aluno{% else %}Professor{% endif %}:</small>
                    <small>
                        {% if modelo == 'receita' %}
                            {{ lancamento.aluno.nome_completo|title|default:"-" }}
                        {% else %}
                            {{ lancamento.professor.get_full_name|title|default:"-" }}
                        {% endif %}
                    </small>
                </div>
                <div class="d-flex justify-content-between fw-bold mt-2">
                    <span>Valor:</span>
                    <span>R$ {{ lancamento.valor|floatformat:2|intcomma }}</span>
                </div>
            </div>
        {% endfor %}
        </div>
        <div class="card-footer text-end fw-bold">
            Total de {{ ano|stringformat:"d" }}: <span class="ms-2 h6 mb-0">R$ {{ dados.total_ano|floatformat:2|intcomma }}</span>
        </div>
    </div>
{% empty %}
    <div class="text-center text-muted p-4">
        Nenhum lançamento encontrado para esta categoria.
    </div>
{% endfor %}
{% if dados_agrupados %}
    <div class="card shadow-sm mb-3 bg-primary text-white p-3 text-end fw-bold">
        TOTAL GERAL:
        <span class="h5 mb-0">R$ {{ total_geral|floatformat:2|intcomma }}</span>
    </div>
{% endif %}
</div>
{% endblock %}