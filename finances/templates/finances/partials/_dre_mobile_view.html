{% load humanize %}
{% include 'finances/partials/_dre_kpi_cards.html' %}

<div class="row g-2">
    <div class="col-12">

        <div class="card shadow-sm mb-3">
            <div class="card-header d-flex justify-content-between align-items-center accordion-toggle p-3" data-bs-toggle="collapse" data-bs-target="#receitas-list-mobile">
                <span class="fw-bold text-success">+ Receita Operacional Bruta</span>
                <i class="bi bi-chevron-down rotate-icon"></i>
            </div>
            <div id="receitas-list-mobile" class="collapse show card-body dre-card-body-scrollable">
                <div class="dre-card-header-sticky d-flex justify-content-between small text-muted fw-bold px-3 pt-2 pb-2 border-bottom">
                    <span>Categoria</span>
                    <span class="text-end">Valores</span>
                </div>
                <div class="dre-card-content">
                    {% if dre_comp %}
                        {% for item in merged_receitas %}
                        <div class="dre-item-mobile">
                            <div class="category-name"><a href="{% url 'finances:dre_details' %}?modelo=receita&categoria={{ item.name }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&start_date_comp={{ request.GET.start_date_comp }}">+ {{ item.name }}</a></div>
                            <div class="values-block">
                                <div class="main-value text-success">R$ {{ item.principal|floatformat:2|intcomma }}</div>
                                <div class="comp-value d-flex justify-content-end align-items-center gap-1">
                                    <span class="badge {% if item.var_perc >= 0 %}bg-success-subtle text-success-emphasis{% else %}bg-danger-subtle text-danger-emphasis{% endif %}">
                                        <i class="bi {% if item.var_perc >= 0 %}bi-arrow-up-short{% else %}bi-arrow-down-short{% endif %}"></i>
                                        {{ item.var_perc|floatformat:1 }}%
                                    </span>
                                    <span class="text-muted">vs R$ {{ item.comparativo|floatformat:2|intcomma }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for item in dre_principal.receitas_por_categoria %}
                        <div class="dre-item-mobile">
                            <div class="category-name"><a href="{% url 'finances:dre_details' %}?modelo=receita&categoria={{ item.categoria__name }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">+ {{ item.categoria__name }}</a></div>
                            <div class="values-block"><div class="main-value text-success">R$ {{ item.total_cat|floatformat:2|intcomma }}</div></div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-3">
             <div class="card-header d-flex justify-content-between align-items-center accordion-toggle p-3" data-bs-toggle="collapse" data-bs-target="#custos-list-mobile">
                <span class="fw-bold text-danger">- Custos Diretos</span>
                <i class="bi bi-chevron-down rotate-icon"></i>
            </div>
            <div id="custos-list-mobile" class="collapse show card-body dre-card-body-scrollable">
                <div class="dre-card-header-sticky d-flex justify-content-between small text-muted fw-bold px-3 pt-2 pb-2 border-bottom">
                    <span>Categoria</span>
                    <span class="text-end">Valores</span>
                </div>
                <div class="dre-card-content">
                    {% if dre_comp %}
                        {% for item in merged_custos %}
                        <div class="dre-item-mobile">
                            <div class="category-name"><a href="{% url 'finances:dre_details' %}?modelo=despesa&classificacao=custo&categoria={{ item.name }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&start_date_comp={{ request.GET.start_date_comp }}">- {{ item.name }}</a></div>
                            <div class="values-block">
                                <div class="main-value">R$ {{ item.principal|floatformat:2|intcomma }}</div>
                                <div class="comp-value d-flex justify-content-end align-items-center gap-1">
                                    <span class="badge {% if item.var_perc <= 0 %}bg-success-subtle text-success-emphasis{% else %}bg-danger-subtle text-danger-emphasis{% endif %}">
                                        <i class="bi {% if item.var_perc <= 0 %}bi-arrow-down-short{% else %}bi-arrow-up-short{% endif %}"></i>
                                        {{ item.var_perc|floatformat:1 }}%
                                    </span>
                                    <span class="text-muted">vs R$ {{ item.comparativo|floatformat:2|intcomma }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for item in dre_principal.custos_por_categoria %}
                         <div class="dre-item-mobile">
                            <div class="category-name"><a href="{% url 'finances:dre_details' %}?modelo=despesa&classificacao=custo&categoria={{ item.categoria__name }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">- {{ item.categoria__name }}</a></div>
                            <div class="values-block"><div class="main-value">R$ {{ item.total_cat|floatformat:2|intcomma }}</div></div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-3">
             <div class="card-header d-flex justify-content-between align-items-center accordion-toggle p-3" data-bs-toggle="collapse" data-bs-target="#despesas-list-mobile">
                <span class="fw-bold text-danger">- Despesas Operacionais</span>
                <i class="bi bi-chevron-down rotate-icon"></i>
            </div>
            <div id="despesas-list-mobile" class="collapse show card-body dre-card-body-scrollable">
                <div class="dre-card-header-sticky d-flex justify-content-between small text-muted fw-bold px-3 pt-2 pb-2 border-bottom">
                    <span>Categoria</span>
                    <span class="text-end">Valores</span>
                </div>
                <div class="dre-card-content">
                    {% if dre_comp %}
                        {% for item in merged_despesas %}
                        <div class="dre-item-mobile">
                            <div class="category-name"><a href="{% url 'finances:dre_details' %}?modelo=despesa&classificacao=despesa&categoria={{ item.name }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}&start_date_comp={{ request.GET.start_date_comp }}">- {{ item.name }}</a></div>
                            <div class="values-block">
                                <div class="main-value">R$ {{ item.principal|floatformat:2|intcomma }}</div>
                                <div class="comp-value d-flex justify-content-end align-items-center gap-1">
                                    <span class="badge {% if item.var_perc <= 0 %}bg-success-subtle text-success-emphasis{% else %}bg-danger-subtle text-danger-emphasis{% endif %}">
                                        <i class="bi {% if item.var_perc <= 0 %}bi-arrow-down-short{% else %}bi-arrow-up-short{% endif %}"></i>
                                        {{ item.var_perc|floatformat:1 }}%
                                    </span>
                                    <span class="text-muted">vs R$ {{ item.comparativo|floatformat:2|intcomma }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        {% for item in dre_principal.despesas_por_categoria %}
                        <div class="dre-item-mobile">
                            <div class="category-name"><a href="{% url 'finances:dre_details' %}?modelo=despesa&classificacao=despesa&categoria={{ item.categoria__name }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}">- {{ item.categoria__name }}</a></div>
                            <div class="values-block"><div class="main-value">R$ {{ item.total_cat|floatformat:2|intcomma }}</div></div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-body p-3 d-flex justify-content-between align-items-center bg-light-subtle">
                <span class="h6 mb-0 fw-bold">(=) Lucro Bruto</span>
                <span class="h6 mb-0 {% if dre_principal.lucro_bruto < 0 %}text-danger{% else %}text-success{% endif %}">
                    R$ {{ dre_principal.lucro_bruto|floatformat:2|intcomma }}
                </span>
            </div>
        </div>
        <div class="card shadow-sm mb-3">
             <div class="card-body p-3 d-flex justify-content-between align-items-center fw-bold {% if dre_principal.resultado < 0 %}bg-danger-subtle text-danger-emphasis{% else %}bg-success-subtle text-success-emphasis{% endif %}">
                <span class="h6 mb-0">(=) Resultado do Per√≠odo</span>
                <span class="h6 mb-0">
                    R$ {{ dre_principal.resultado|floatformat:2|intcomma }}
                </span>
            </div>
        </div>
    </div>
</div>

<style>
.rotate-icon {
  transition: transform 0.2s ease;
}
.accordion-toggle:not(.collapsed) .rotate-icon {
  transform: rotate(-180deg);
}
.category-name a {
  text-decoration: none;
  color: inherit;
}
.category-name a:hover {
  text-decoration: underline;
}
</style>